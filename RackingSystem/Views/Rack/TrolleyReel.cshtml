
<style>

    :root {
        --bg-main: #2c3e50;
        --text-color: #ecf0f1;
        --accent-color: #3498db;
        --status-ok: #2ecc71;
        --status-alarm: #e74c3c;
        --card-bg: #34495e;
    }

    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* background-color: var(--card-bg); */
        /* padding: 20px 20px; */
        /* border-bottom: 3px solid var(--accent-color); */
    }

    .header-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        width: 60%;
    }

        .input-header {
            padding: 8px 12px;
            background-color: var(--bg-main);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            appearance: none;
            cursor: pointer;
        }

    .btn-header {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        background-color: var(--accent-color);
        border: none;
        color: white;
        font-size: 16px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

        .btn-header:hover {
            background-color: #2980b9;
        }

    .control-btn {
        padding: 10px 15px;
        font-weight: bold;
        min-width: 100px;
        margin: 0;
    }

    .trolley {
        display: flex;
        gap: 40px;
        flex-wrap: nowrap;
        justify-content: center;
        overflow-x: auto
    }

    .side {
        border: 1px solid #333;
        padding: 20px;
        border-radius: 10px;
        background: #1a1a1a
    }

    .grid {
        display: flex;
        gap: 20px
    }

    .column {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 6px;
        background: #0003;
        border-radius: 6px
    }

    .sub-column {
        display: flex;
        flex-direction: column;
        gap: 4px
    }

    .sub-container {
        display: flex;
        flex-direction: row;
        gap: 20px
    }

    .cell {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        /* background: #333; */
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid lightgrey;
    }

        .cell.on {
            background: #00ffa2;
            box-shadow: 0 0 10px #00ffa2
        }

    .search-box {
        margin-bottom: 20px;
        text-align: center
    }

        .search-box input {
            width: 30%;
            display: inline;
        }

        .search-box select {
            width: 30%;
            display: inline;
        }

    .col-label {
        color: #0af;
        font-size: 12px;
        text-align: center;
        margin-bottom: 6px
    }

    .row-label {
        color: #888;
        font-size: 11px;
        width: 26px;
        text-align: right
    }

    .row-wrap {
        display: flex;
        align-items: center;
        gap: 6px
    }

    .cell:hover {
        transform: scale(1.06)
    }

    .cell.empty {
        background: #222;
        opacity: 0.3;
        border: 1px dashed #555
    }

    .controls {
        margin-top: 10px;
        text-align: center
    }

    .tblRow {
        padding: 0 !important;
    }

    .tblCol1 {
        width: 20%;
        align-content: center;
        font-size: 11px;
        color: #0af;
    }

    .tblCol2 {
        width: 20%;

    }

    .tblCol3 {
        width: 50%;
    }

</style>

@section PageHeader {
    <header class="d-flex align-items-center justify-content-between w-100">
        <h2 class="pageTitle">Trolley Reels</h2>
        <div class="header-controls">
            <div class="input-container">
                <label for="trolleyId">Trolley:</label>
                <input type="text" class="input-header" id="trolleyId" />
            </div>
            <button id="loadBtn" class="loadBtn btn-header" style="margin-right:30px;">Load </button>
        </div>
    </header>
}

<div class="container-fluid">
    <br />

    <div class="search-box">
        <input id="reelId" class="form-control" type="text" placeholder="Enter Reel ID / Raw Mat Code / BOM Code" />
        @* <select id="bomId" class="form-control">
            <option>- </option>
            <option>BOM 1 </option>
            <option>BOM 2 </option>
            <option>BOM 3 </option>
        </select> *@
        <button id="findBtn" class="btn btn-success">Turn ON LED</button>
        <button id="turnOffBtn" class="btn btn-danger">Turn Off LED</button>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12 col-md-6" style="border: 1px solid lightgrey;">
                <p style="text-align: center;">A Side</p>
                <div class="row">
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="A1">
                            <tbody id="A1Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2" style="border-right: 1px solid lightgrey;">
                        <table class="table table-striped table-hover" id="A2">
                            <tbody id="A2Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="A3">
                            <tbody id="A3Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2" style="border-right: 1px solid lightgrey;">
                        <table class="table table-striped table-hover" id="A4">
                            <tbody id="A4Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="A5">
                            <tbody id="A5Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="A6">
                            <tbody id="A6Body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6" style="border: 1px solid lightgrey;">
                <p style="text-align: center;">B Side</p>
                <div class="row">
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="B1">
                            <tbody id="B1Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2" style="border-right: 1px solid lightgrey;">
                        <table class="table table-striped table-hover" id="B2">
                            <tbody id="B2Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="B3">
                            <tbody id="B3Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2" style="border-right: 1px solid lightgrey;">
                        <table class="table table-striped table-hover" id="B4">
                            <tbody id="B4Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="B5">
                            <tbody id="B5Body"></tbody>
                        </table>
                    </div>
                    <div class="col-2">
                        <table class="table table-striped table-hover" id="B6">
                            <tbody id="B6Body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<input type="hidden" id="xToken" value="@ViewBag.xToken" autocomplete="off">

@section Scripts
{
    @* <link href="~/css/datatables.min.css" rel="stylesheet"> *@
    <link rel="stylesheet" href="~/css/sweetalert2.min.css">

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/js/datatables.min.js"></script>
    <script src="~/js/sweetalert2.all.min.js"></script>

    <script type="text/javascript">
        let token = '';

        $(document).ready(function () {
            token = $('#xToken').val();
        });

        document.getElementById('loadBtn').addEventListener('click',loadTrolley);
        document.getElementById('findBtn').addEventListener('click',findReel);
        // document.getElementById('reelId').addEventListener('keydown',e=>{if(e.key==='Enter')findReel();});

        function turnOffReel(){
            // call api to close
            var arr = [];
            const divs = document.getElementsByClassName('on');
            for (let i = 0; i < divs.length; i++) {
                // Access each div using divs[i]
                var id = divs[i].getAttribute('data-id');
                arr.push(id);
            }

            $.ajax({
                url: '/api/PLCTrolley/TurnOffTrolleyOut',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                data: JSON.stringify(arr),
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                },
                success: function (result) {
                    if (result.success == true) {
                        //
                    }
                    else {
                        console.log(result.errMessage);
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });

            // set ui to off
            document.querySelectorAll('.cell.on').forEach(c => {
                c.classList.remove('on');
                var id = c.getAttribute('data-id');
                var cell3 = document.getElementById('C3' + id);
                cell3.innerHTML = "";
            });
        }

        // function highlightByReelId(reelId){
        //     clearAll();
        //     const p=reelMap[reelId];
        //     if(!p)return false;

        //     const selector=`.side .column[data-side="${p.side}"][data-col="${p.column}"] .cell[data-row="${p.row}"]`;
        //     const cell=document.querySelector(selector);
        //     if(cell){
        //         cell.classList.add('on');
        //         cell.scrollIntoView({behavior:'smooth',block:'center'});
        //         return true;
        //     }
        //     return false;
        // }

        async function findReel() {
            const tr = document.getElementById('trolleyId').value.trim();
            if (tr == "") {
                alert('Please insert Trolley Code');
                return;
            }

            const r = document.getElementById('reelId').value.trim();

            await $.ajax({
                url: "/api/PLCTrolley/SearchTrolleyOut/" + tr + "/" + r,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                    Swal.fire({
                        text: 'Please Wait',
                        width: '300px',

                        allowEscapeKey: false,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                    Swal.showLoading()
                },
                success: function (result) {
                    console.log(result); 
                    swal.close();

                    var colNo = 1;
                    if (result.success == true) {

                        for (let i = 0; i < result.data.length; i++) {

                            var side = result.data[i].isLeft == true ? 'A' : 'B';
                            var parentDiv = document.getElementById(side + result.data[i].colNo + 'R' + result.data[i].rowNo);
                            const cell = parentDiv.firstElementChild;
                            cell.classList.add('on');

                        }

                    }
                    else {
                        swal.fire({
                            icon: 'error',
                            title: "Wait",
                            text: result.errMessage
                        });
                        // alert('Trolley :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    swal.fire({
                        icon: 'error',
                        title: "Wait",
                        text: error.val
                    });
                    // alert('Trolley :: ' + error.val, 'alert');
                }
            });

        }

        async function loadTrolley() {
            const tr = document.getElementById('trolleyId').value.trim();
            if (tr == "") {
                alert('Please insert Trolley Code');
                return;
            }

            await $.ajax({
                url: "/api/PLCTrolley/StartTrolleyOut/" + tr,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                    Swal.fire({
                        text: 'Please Wait',
                        width: '300px',

                        allowEscapeKey: false,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                    Swal.showLoading()
                },
                success: function (result) {
                    // console.log(result);
                    swal.close();

                    var colNo = 1;
                    if (result.success == true) {

                        var idx = 1;
                        for (let iC = 1; iC <= 6; iC++) {
                            const tbl = document.getElementById('A' + iC);
                            const tableBody = document.getElementById('A' + iC + 'Body');
                            tableBody.innerHTML = '';

                            if (iC == 1 || iC == 3 || iC == 5) {
                                idx = 1;
                            }

                            colNo = 1;
                            if (iC >=5) { colNo = 3; }
                            if (iC >=3) { colNo = 2; }

                            for (let i = 0; i < 25; i++) { // Example: Add 5 rows

                                var slotId = "";
                                var reelNo = "";
                                var hasReel = false;
                                result.data.forEach(x => {
                                    if (x.isLeft == true && x.hasReel == true && x.colNo == colNo && x.rowNo === idx && x.reelNo == "0") {
                                    hasReel = true;
                                    }
                                    if (x.isLeft == true && x.colNo == colNo && x.rowNo === idx) {
                                        reelNo = x.reelNo;
                                        slotId = x.trolleySlot_Id; 
                                    }
                                });

                                // const rawData = JSON.stringify(result.data[idx - 1]);
                                const newRow = tbl.insertRow(); // or document.createElement('tr');
                                const cell1 = newRow.insertCell(); // or document.createElement('td');
                                cell1.innerHTML = idx;
                                $(cell1).addClass("tblRow tblCol1");
                                const cell2 = newRow.insertCell();
                                cell2.id = 'A' + iC + "R" + idx;
                                cell2.innerHTML = ' <div class="cell" data-id="' + slotId + '"></div> ';
                                $(cell2).addClass("tblRow tblCol2 ");
                                const cell3 = newRow.insertCell(); // or document.createElement('td');
                                cell3.id = 'C3' + slotId;
                                cell3.innerHTML = hasReel == true ? "xxx" : '   ';
                                $(cell3).addClass("tblRow tblCol3");

                                idx = idx + 1;
                            }
                        }

                        idx = 1;
                        for (let iC = 1; iC <= 6; iC++) {
                            const tbl = document.getElementById('B' + iC);
                            const tableBody = document.getElementById('B' + iC + 'Body');
                            tableBody.innerHTML = '';

                            if (iC == 1 || iC == 3 || iC == 5) {
                                idx = 1;
                            }

                            colNo = 1;
                            if (iC >=5) { colNo = 3; }
                            if (iC >=3) { colNo = 2; }

                            for (let i = 0; i < 25; i++) { // Example: Add 5 rows

                                var reelNo = "";
                                var hasReel = false;
                                result.data.forEach(x => {
                                    if (x.isLeft == false && x.hasReel == true && x.colNo == colNo && x.rowNo === idx && x.reelNo == "0") {
                                    hasReel = true;
                                    }
                                    if (x.isLeft == false && x.colNo == colNo && x.rowNo === idx) {
                                    reelNo = x.reelNo;
                                    }
                                });

                                // const rawData = JSON.stringify(result.data[idx - 1]);
                                const newRow = tbl.insertRow(); // or document.createElement('tr');
                                const cell1 = newRow.insertCell(); // or document.createElement('td');
                                cell1.innerHTML = idx;
                                $(cell1).addClass("tblRow tblCol1");
                                const cell2 = newRow.insertCell();
                                cell2.id = 'B' +iC + "R" + idx;
                                cell2.innerHTML = ' <div class="cell"></div> ';
                                $(cell2).addClass("tblRow tblCol2 ");
                                const cell3 = newRow.insertCell(); // or document.createElement('td');
                                cell3.innerHTML = hasReel == true ? "xxx" : '   ';
                                $(cell3).addClass("tblRow tblCol3");

                                idx = idx + 1;
                            }
                        }

                    }
                    else {
                        swal.fire({
                            icon: 'error',
                            title: "Wait",
                            text: result.errMessage
                        });
                        // alert('Trolley :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    swal.fire({
                        icon: 'error',
                        title: "Wait",
                        text: error.val
                    });
                    // alert('Trolley :: ' + error.val, 'alert');
                }
            });


        }

        // async function loadPLCOn(colNo, rowNo) {
        //     // console.log(colNo + " || " + rowNo);

        //     await $.ajax({
        //         url: "/api/PLCHubIn/SetTrolleyOn/" + colNo + "/" + rowNo,
        //         type: "GET",
        //         headers: {
        //             'Authorization': 'Bearer ' + token
        //         },
        //         dataType: 'JSON',
        //         // data: JSON.stringify(jsonInput),
        //         contentType: 'application/json; charset=utf-8',
        //         beforeSend: function () {
        //             Swal.fire({
        //                 text: 'Please Wait',
        //                 width: '300px',

        //                 allowEscapeKey: false,
        //                 allowOutsideClick: false,
        //                 showConfirmButton: false,
        //             });
        //             Swal.showLoading()
        //         },
        //         success: function (result) {
        //             // console.log(result);
        //             swal.close();

        //             if (result.success == true) {

        //             }
        //             else {
        //                 alert('ON :: ' + result.errMessage, 'alert');
        //             }
        //         },
        //         error: function (error) {
        //             alert('ON :: ' + error.val, 'alert');
        //         }
        //     });


        // }

        // Turn off LED with optional Auto Close
        let autoOffTimeout;
        document.getElementById('turnOffBtn').addEventListener('click',()=>{
          turnOffReel();
          // if(document.getElementById('autoClose').checked){
          //   if(autoOffTimeout) clearTimeout(autoOffTimeout);
          //   autoOffTimeout = setTimeout(clearAll, 5*60*1000);
          // }
        });

        // window._debug={reelMap,rawMatMap,bomMap};
    </script>
}

