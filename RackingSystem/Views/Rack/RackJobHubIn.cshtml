@{
    Layout = "~/Views/Shared/_LayoutEmpty.cshtml";
}

<style>

    :root {
        --bg-main: #2c3e50;
        --text-color: #ecf0f1;
        --accent-color: #3498db;
        --status-ok: #2ecc71;
        --status-alarm: #e74c3c;
        --card-bg: #34495e;
    }

    body {
        /* font-family: 'Segoe UI', Arial, sans-serif; */
        background-color: var(--bg-main);
        color: var(--text-color);
        margin: 0;
        padding: 0;
    }

    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--card-bg);
        padding: 20px 20px;
        /* border-bottom: 3px solid var(--accent-color); */
    }

    .header-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .select-container label {
        margin-right: 8px;
        font-size: 0.9em;
        color: var(--text-color);
    }

    select {
        padding: 8px 12px;
        background-color: var(--bg-main);
        color: var(--text-color);
        border: 1px solid var(--accent-color);
        border-radius: 4px;
        appearance: none;
        cursor: pointer;
    }

        select:focus {
            outline: none;
            border-color: var(--status-ok);
        }

    .select-container {
        position: relative;
    }

        .select-container::after {
            content: '▼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-color);
            font-size: 0.7em;
        }

    .single-page-layout input:not([type]), input[type="text"], input[type="number"] {
        padding: 8px 12px;
        background-color: var(--bg-main);
        color: var(--text-color);
        border: 1px solid var(--accent-color);
        border-radius: 4px;
        appearance: none;
        cursor: pointer;
    }

    .system-status {
        text-align: right;
    }

    button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        background-color: var(--accent-color);
        border: none;
        color: white;
        font-size: 16px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

        button:hover {
            background-color: #2980b9;
        }

    .control-btn {
        padding: 10px 15px;
        font-weight: bold;
        min-width: 100px;
        margin: 0;
    }

    .start-btn {
        background-color: var(--status-ok); /* Green */
    }

        .start-btn:hover {
            background-color: #27ae60;
        }

    .stop-btn {
        background-color: var(--status-alarm); /* Red */
    }

        .stop-btn:hover {
            background-color: #c0392b;
        }

    .control-btn:disabled {
        background-color: #7f8c8d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .single-page-layout {
        display: flex;
        justify-content: space-around;
        padding: 20px;
        gap: 20px;
    }

    .control-session {
        flex-basis: 50%;
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .control-session-list {
        flex-basis: 20%;
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* --- Gantry Specific Styles --- */
    .process-visualization {
        display: flex;
        align-items: center;
        justify-content: space-around;
        margin-top: 20px;
        padding: 20px;
        background-color: var(--bg-main);
        border-radius: 8px;
        min-height: 265px;
    }

    .station {
        text-align: center;
        width: 150px;
    }

    .gantry-path {
        flex-grow: 1;
        height: 10px;
        background-color: var(--card-bg);
        position: relative;
        margin: 0 20px;
    }

    .gantry-head {
        border-radius: 50%;
        width: 30px;
        height: 30px; // 40px;
        background-color: var(--accent-color);
        position: absolute;
        top: -10px; // -15px;
        transition: left 2s ease-in-out, background-color 0.3s;
    }

        .gantry-head[data-position="loader"] {
            left: 0%;
        }

        .gantry-head[data-position="pickup"] {
            left: 100%;
            transform: translateX(-100%);
        }

        .gantry-head[data-has-reel="true"] {
            background-color: var(--status-ok);
        }

    /* Loader Viewport acts as a mask/window */
    .loader-viewport {
        width: 100%;
        overflow: hidden;
        margin-top: 10px;
    }

    /* Loader Track holds all columns and moves */
    .loader-track {
        display: flex;
        width: 100%;
        transition: transform 0.8s ease-in-out; /* Smooth sliding animation */
    }

        /* When the loader track has this class, we apply a dimming effect */
        .loader-track.picking-dim .col {
            opacity: 0.4;
            transition: opacity 0.3s ease-in-out;
        }

            /* The actively selected column should remain fully visible */
            .loader-track.picking-dim .col.active-pick {
                opacity: 1.0;
            }

            /* Ensure the reel counts and labels within dimmed columns are still somewhat readable */
            .loader-track.picking-dim .col * {
                /* Optional: Maintain slightly higher visibility for text elements */
                /* opacity: 1.0; */
            }

    /* Individual columns within the track */
    .col {
        width: 25%;
        flex-shrink: 0;
        background-color: var(--bg-main);
        border: 2px solid var(--card-bg);
        padding: 5px;
        border-radius: 5px;
        position: relative;
        text-align: center;
    }

    .col-label {
        display: block;
        font-size: 0.8em;
        margin-bottom: 5px;
    }

    .reel {
        width: 100%;
        height: 40px;
        background-color: #95a5a6;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    .col[data-status="full"] {
        border-color: var(--status-ok);
    }

    .col[data-status="empty"] {
        /* border-color: var(--status-alarm); */
        border-color: grey;
    }

    .col[data-status="full"] .reel {
        background-color: #7f8c8d;
    }

    .col[data-status="empty"] .reel {
        display: none;
    }

    .col[data-status="empty"] {
        padding-top: 20px;
        padding-bottom: 20px;
    }

    .reel-count {
        display: block;
        margin-top: 5px;
        font-size: 0.9em;
        font-weight: bold;
        color: var(--text-color);
    }

        .reel-count[data-count="0"] {
            /* color: var(--status-alarm); */
            color: grey;
        }

    /* Define the position classes managed by JavaScript */
    .loader-track.pos-col-1 {
        transform: translateX(0%);
    }

    .loader-track.pos-col-2 {
        transform: translateX(-25%);
    }

    .loader-track.pos-col-3 {
        transform: translateX(-50%);
    }

    .loader-track.pos-col-4 {
        transform: translateX(-75%);
    }


    /* Loader Battery Display (Single instance) */
    .loader-battery-display {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
    }

        .loader-battery-display .battery-container {
            width: 80px;
            height: 15px;
            background-color: var(--bg-main);
            border: 1px solid var(--text-color);
            border-radius: 3px;
            overflow: hidden;
        }

        .loader-battery-display .battery-level {
            height: 100%;
            background-color: var(--status-ok);
            transition: width 0.5s ease-in-out, background-color 0.5s;
        }

        .loader-battery-display .battery-text {
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
            color: var(--text-color);
        }

        .loader-battery-display .battery-critical {
            background-color: var(--status-alarm) !important;
        }

        .loader-battery-display .battery-low {
            background-color: #f1c40f !important;
        }


    /* Drawer Station */
    .drawer-station {
        width: 200px;
    }

    .drawer {
        width: 100%;
        height: 60px;
        background-color: var(--bg-main);
        border: 2px solid var(--accent-color);
        border-radius: 5px;
        margin-top: 10px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .reel-on-drawer {
        width: 90%;
        height: 40px;
        background-color: transparent;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    .drawer[data-status="Placed"] .reel-on-drawer {
        background-color: #7f8c8d;
    }

    .drawer[data-status="None"] {
        /* border-color: var(--status-alarm); */
        border-color: grey;
    }

    .drawer[data-status="Drawer"] {
        /* border-color: var(--status-alarm); */
        border-color: var(--status-ok);
    }

    .drawer[data-status="Placed"] {
        border-color: var(--status-alarm);
        /* background-color: #5d6d7e; */
    }

    #drawer-status-text.unavailable, #fork-status-text.unavailable {
        color: var(--status-alarm);
        font-weight: bold;
    }

    /* --- Cartesian Specific Styles (Simplified) --- */
    .simplified-rack-visualization {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 10px;
        background-color: var(--bg-main);
        min-height: 265px;
        margin-top: 20px;
    }

    .rack-area {
        flex-basis: 40%;
        padding: 20px;
        background-color: var(--card-bg);
        border: 2px solid transparent;
        text-align: center;
        min-height: 100px;
    }

    .rack-center {
        flex-basis: 15%;
        text-align: center;
    }

    .robot-location {
        background-color: var(--accent-color);
        padding: 10px;
        border-radius: 5px;
        transition: background-color 0.5s;
        margin-bottom: 10px;
    }

    .rack-area.active {
        border-color: var(--status-ok);
        background-color: #34495e;
        box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
    }

    /* --- System Log Area --- */
    .system-log-container {
        background-color: var(--card-bg);
        margin: 0px 20px 20px 20px;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--accent-color);
    }

    #system-log {
        background-color: var(--bg-main);
        color: #7f8c8d;
        height: 150px;
        overflow-y: auto;
        padding: 10px;
        font-family: monospace;
        font-size: 0.9em;
        border-radius: 4px;
    }

    #system-log-2 {
        background-color: var(--bg-main);
        color: #7f8c8d;
        height: 150px;
        overflow-y: auto;
        padding: 10px;
        font-family: monospace;
        font-size: 0.9em;
        border-radius: 4px;
    }

    #system-log-3 {
        background-color: var(--bg-main);
        color: #7f8c8d;
        height: 90%;
        overflow-y: auto;
        padding: 10px;
        font-family: monospace;
        font-size: 0.9em;
        border-radius: 4px;
    }

    .log-entry {
        margin-bottom: 3px;
        white-space: nowrap;
    }

    .log-info {
        color: var(--text-color);
    }

    .log-alert {
        color: var(--status-alarm);
        font-weight: bold;
    }

    .log-success {
        color: var(--status-ok);
    }

    footer {
        text-align: center;
        padding: 10px;
        background-color: var(--card-bg);
        width: 100%;
    }

    .hidden {
        display: none;
    }
    
    #jsonModal .form-modal {
        padding: 8px 12px;
        background-color: white;
        color: black;
        border: 1px solid var(--accent-color);
        border-radius: 4px;
        appearance: none;
        cursor: pointer;
    }

    .reel-card {
        background-color: var(--card-bg);
        /* background: linear-gradient(145deg,#0f172a,#020617); */
        border-radius: 5px;
        padding: 20px;
        transition: 0.3s;
        /* border: 1px solid #1e293b; */
        margin-bottom : 10px;
    }

        /* .reel-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(99,102,241,0.4);
        } */

    .reel-info h3 {
        margin-bottom: 8px;
    }

    .reel-info p {
        font-size: 14px;
        margin: 2px 0;
        color: white;
    }

    .badge {
        display: inline-block;
        margin-top: 10px;
        background: #6366f1;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
    }

        .badge.live {
            background: #22c55e;
        }

    .fade-out {
        opacity: 0;
        /* This transition duration should match the delay in the JavaScript setTimeout */
        transition: opacity 0.5s ease-out;
    }
</style>

<header>
    <h1 onclick="showJSONModal()">SRMS </h1>

    <input type="hidden" id="xToken" value="@ViewBag.xToken" autocomplete="off">
    <input type="hidden" id="xQId" value="@ViewBag.QId" autocomplete="off">
    <input type="hidden" id="xDeviceId" value="@ViewBag.DeviceId" autocomplete="off">
    <input type="hidden" id="xQContinuos" value="@ViewBag.QContinuos" autocomplete="off">

    <input type="hidden" id="txtSetUnload" autocomplete="off">
    <input type="hidden" id="txtLoaderId" autocomplete="off">
    <input type="hidden" id="txtCol1TotalReels" autocomplete="off">
    <input type="hidden" id="txtCol2TotalReels" autocomplete="off">
    <input type="hidden" id="txtCol3TotalReels" autocomplete="off">
    <input type="hidden" id="txtCol4TotalReels" autocomplete="off">

    <div class="header-controls">
        <div class="input-container">
            <label for="job-input">Job:</label>
            <input type="text" id="job-input" value="@ViewBag.QNo" disabled />
        </div>

        <div class="input-container">
            <label for="loader-input">Loader:</label>
            <input type="text" id="loader-input" />
        </div>

        <button id="cont-btn" onclick="systemCont()" class="control-btn start-btn hidden">Continue</button>
        <button id="start-btn" onclick="systemStart()" class="control-btn start-btn">Start</button>
        <button id="stop-btn" onclick="systemStop()" class="control-btn stop-btn">Stop</button>
        @* <button id="forcestop-btn" onclick="systemForceStop()" class="control-btn stop-btn">Force Stop</button> *@
    </div>

    <div class="system-status">
        Status: <span id="master-status">Ready</span>
        <div class="input-container">
            <label for="chkAutoRun">Auto:</label>
            <input type="checkbox" id="chkAutoRun" />
        </div>
    </div>

</header>

<main class="single-page-layout">
    <!-- Gantry Session Interface (Left Column) -->
    <section id="gantry-session" class="control-session">
        <h2>Gantry <span style="font-size: 1.2rem;">(Pick & Place)</span></h2>

        <div class="process-visualization">
            <!-- Loader Section (Left Point) -->
            <div class="station loader">
                <h4>Auto Loader</h4>
                <div class="loader-viewport">
                    <!-- The inner track that moves left or right -->
                    <div class="loader-track picking-dim">
                        <div class="col" id="col-1" data-status="full"><span class="col-label">C1</span><div class="reel"></div><span class="reel-count" data-count="0">- left</span></div>
                        <div class="col" id="col-2" data-status="full"><span class="col-label">C2</span><div class="reel"></div><span class="reel-count" data-count="0">- left</span></div>
                        <div class="col" id="col-3" data-status="full"><span class="col-label">C3</span><div class="reel"></div><span class="reel-count" data-count="0">- left</span></div>
                        <div class="col" id="col-4" data-status="full"><span class="col-label">C4</span><div class="reel"></div><span class="reel-count" data-count="0">- left</span></div>
                    </div>
                </div>
                @* <p>Next Pick: Column <span id="next-pick-col">1</span></p> *@
                <br />
                <div class="loader-battery-display">
                    <div class="battery-container">
                        <div class="battery-level" id="loader-battery-level" data-percent="80" style="width: 80%;"></div>
                    </div>
                    <span class="battery-text" id="loader-battery-text">- %</span>
                </div>
            </div>

            <!-- Gantry Path Visual -->
            <div class="gantry-path">
                <div class="gantry-head" data-position="loader" data-has-reel="false"></div>
                <br />
                <span id="txtReel">Reel : -</span>
            </div>

            <!-- Drawer/Placement Section (Right Point & Interface) -->
            <div class="station drawer-station">

                <h4>Place on Drawer</h4>
                <div class="drawer" data-status="None">
                    <div class="reel-on-drawer"></div>
                </div>
                <p> <span id="drawer-status-text">No Drawer</span></p>
                @* <p>Fork Status: <span id="fork-status-text">Retracted</span></p>  Awaiting Place Command *@
                <div id="gantry-hold-status" >
                    🚨 Reel Picked!🚨
                </div>
                <br />
            </div>
        </div>

        <div class="gantry-controls">
            <br />
            <button onclick="startPick()">Pick</button>
            <button onclick="startPlace()">Place</button>
            <hr />
            <a href="javascript:loadPLCSetLoaderUnload()">Set Unload</a> > <a href="javascript:loadPLCScanReelID()">Scan QR</a> > <a href="javascript:loadPLCScanReelID()">Reed Reel</a> > <a href="javascript:loadPLCSetActualHeight()">Set Height (Pick)</a>
            <br />
            <a href="javascript:retry_PickStatus()">Pick Status</a> > <a href="javascript:loadPLCPlaceReel()">Place</a> > <a href="javascript:retry_PlaceStatus()">Place Status</a>
            <br /> bcv 
            <a href="javascript:loadPLCEndTask()">All Empty</a>
        </div>

        <div style="height:20px;"></div>
        <input type="text" id="txtReelId" placeholder="Reel Id" autocomplete="off">
        <input type="text" id="txtReelCode" placeholder="Reel Code" autocomplete="off">
        <input type="number" id="txtActHeight" placeholder="Height" autocomplete="off">

        <hr />
        <p style="position: relative; text-align: right; margin-bottom: 0; padding-right: 2px;"><a href="javascript:clearLog();" style="color:red;">Clear Log</a></p>
        <div id="system-log">
            <!-- Log entries will be appended here by JavaScript -->
        </div>
    </section>

    <!-- Cartesian Session Interface (Right Column) -->
    <section id="cartesian-session" class="control-session">
        <h2>Cartesian <span style="font-size: 1.2rem;">(Retrieve & Put Away)</span></h2>
        <div class="simplified-rack-visualization">
            <div class="rack-area left-rack" data-area="left">
                <h4>Left Rack Area</h4>
                <input type="text" id="left-input" autocomplete="off" />
                @* <p id="left-status">Status: IDLE</p> *@
            </div>

            <div class="rack-center">
                <div class="robot-location" data-location="center">Robot Arm</div>
                <p> <span id="cartesian-state-simple">Ready</span></p>
            </div>

            <div class="rack-area right-rack" data-area="right">
                <h4>Right Rack Area</h4>
                <input type="text" id="right-input" autocomplete="off" />
                @* <p id="right-status">Status: IDLE</p> *@
            </div>
        </div>
        <div class="cartesian-controls">
            <br />
            <button onclick="startRetrieve()">Retrieve</button>
            <button onclick="startPutAway()">Put Away</button>
            <hr />
            <a href="javascript:loadPLCGetEmptyTraySlot()">Get Drawer Slot</a> > <a href="javascript:loadPLCTakeEmptyTray()">Retrieve</a> >
            <a href="javascript:loadPLCGetSlot()">Get Valid Slot</a> > <a href="javascript:loadPLCPutAway()">Put Away</a>
            <br />
            <a href="javascript:retry_RetrieveStatus()">Retrieve Status</a> > <a href="javascript:retry_PutAwayStatus()">Put Away Status</a>
        </div>

        <input type="text" id="txtRetrieveSlot" placeholder="Retrieve Slot" autocomplete="off">
        <input type="text" id="txtPutSlot" placeholder="Put Slot" autocomplete="off">
        <input type="number" id="txtPutSlotTake" placeholder="Slot Take" autocomplete="off">
        <br />
        <input type="text" id="txtReelIdC" placeholder="Reel Id" autocomplete="off">
        <input type="text" id="txtReelCodeC" placeholder="Reel Code" autocomplete="off">
        <input type="number" id="txtActHeightC" placeholder="Height" autocomplete="off">

        <hr />
        <p style="position: relative; text-align: right; margin-bottom: 0; padding-right: 2px;"><a href="javascript:clearLog2();" style="color:red;">Clear Log</a></p>
        <div id="system-log-2">
            <!-- Log entries will be appended here by JavaScript -->
        </div>
    </section>

    <section id="reel-session" class="control-session-list">
        <h2>
            <span style="font-size: 1.2rem;">Upcoming </span>
        </h2>
        <div id="system-log-3">

            @* <div class="reel-card">
                <div class="chip-img">!12345678</div>
                <div class="reel-info">
                    <p>!12345678</p>
                    <p>Item: xxx</p>
                    <p>Qty: 450</p>
                    <span class="badge">Prototype</span>
                </div>
            </div> *@

        </div>
    </section>
</main>

<div class="modal fade" id="jobDoneModal" role="dialog" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-body" style="padding: 50px;">
                <div class="row">
                    <div class="col-6">
                        <img src="~/assets/img/task.gif" style="width:100%;" />
                    </div>
                    <div class="col-6">
                        <p class="" style="font-size:2em;">Job is done. Click the 'Close' button to close this window.</p>
                        <button class="btn btn-success w-100" style="height: 100px;" onclick="closeTab()">Close</button>
                        <button class="btn btn-secondary w-100" style="height: 100px;" onclick="exportLogFile()">Export Log</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="jsonModal" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnMatchingLabel">Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="csvColumns">
                <div class="row">
                    <div id="jsonColumns"></div>
                </div>
            </div>
            <div class="modal-footer matching-btn">
                <button type="button" class="btn btn-primary" onclick="updateJSONModal()">Submit@* <i class="bi bi-upload fs-5"></i> *@</button>
            </div>
        </div>
    </div>
</div>

@section Scripts
{ 
    <link href="~/css/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/sweetalert2.min.css">

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/js/datatables.min.js"></script>
    <script src="~/js/sweetalert2.all.min.js"></script>
    <script src="../js/xlsx.full.min.js"></script>

    <script type="text/javascript">

        // Centralized state management with system status
        let sharedDrawerState = {
            drawerStatus: 'None', // States: 'Drawer', 'Placed', 'None'
            cartesianRobotState: 'Ready', // 'Ready', 'Retrieving', 'Proceed Put Away'
            cartesianLocation: 'center',
            systemRunning: false, // Overall system run status
            gantrySequenceState: 'Returning', // 'PickedAndHolding', 'Placing', 'Returning'
        };

        let colNum = 1;
        var gantryAutoTimer;
        var cartesianAutoTimer;
        let inPickMove = false;
        let inPlaceMove = false;
        let inRetrieveMove = false;
        let inPutAwayMove = false;

        let halfPickMove = false;
        let halfPlaceMove = false;
        let halfRetrieveMove = false;
        let halfPutAwayMove = false;

        let halfPickMoveStep = 1;
        let halfPlaceMoveStep = 1;
        let halfRetrieveMoveStep = 1;
        let halfPutAwayMoveStep = 1;

        let endTask = false;

        let token = '';
        let qId = 0;
        let deviceId = '';
        let qCont = 0;

        let attemptsPick = 1;
        let attemptsPlace = 1;
        let attemptsRetrieve = 1;
        let attemptsPutAway = 1;
        let changeTakeSlot = false;
        let changePutSlot = false;

        const jsonModal = document.getElementById("jsonModal");
        const formJSON = document.getElementById("formJSON");

        $(document).ready(function () {
            document.getElementById('chkAutoRun').checked = true;
            disableDivContent(true);
            $("#txtReelId").val('');
            $("#txtActHeight").val('0');
            $("#txtActHeightC").val('0');
            $("#txtSetUnload").val('0');
            $("#txtLoaderId").val('0');
            updateSystemStatusUI();
            updateGantryUIState();
            // updateJson();

            token = $('#xToken').val();
            qId = Number($('#xQId').val());
            deviceId = $('#xDeviceId').val();
            qCont = $('#xQContinuos').val();

            if (qCont == "1") {
                $('#cont-btn').removeClass('hidden');
                $('#start-btn').addClass('hidden');
                readyContinuos();
            }

        });

        async function showJSONModal() {

            var data = "";

            await $.ajax({
                url: '/api/PLCHubIn/GetRackJobJson',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                },
                success: function (result) {
                    data = result.data;
                },
                error: function (error) {
                }
            });


            let cols = [ 'SystemStart', 'LoaderCode', 'LoaderId', 'DrawerStatus', 'GantryStatus',
            'SetUnload', 'ReelId', 'ReelCode', 'ActualHeight', 'CartesianRobotState', 'CartesianLocation',
            'RetrieveSlot', 'PutAwaySlot', 'SlotTake', 'ReelIdC', 'ReelCodeC', 'ActualHeightC',
            'HalfPickMove', 'HalfPickMoveStep', 'HalfPlaceMove', 'HalfPlaceMoveStep',
            'ColNum', 'Col1TotalReels', 'Col2TotalReels', 'Col3TotalReels', 'Col4TotalReels', ];

            let columnInputs = '';
            let v = '';

            cols.forEach((column, index) => {
                Object.entries(data).forEach(([key, value]) => {
                  // console.log(`${key}: ${value}`);
                  if (key.toUpperCase() == column.toUpperCase()) {
                      v = value;
                  }
                });

                columnInputs += `
                    <div class="row justify-content-center align-items-center mb-3">
                        <div class="col-5">
                            <label class="form-label mb-0">${column}</label>
                        </div>
                        <div class="col-5">
                            <input type="text" id="col${column}" class="form-modal" value="${v}" />
                        </div>
                    </div>`;
            });


            document.getElementById('jsonColumns').innerHTML = columnInputs;
            $('#jsonModal').modal("show");
        }

        async function updateJSONModal() {

            var data = {
                SystemStart: $("#colSystemStart").val() === "true",

                LoaderCode: $("#colLoaderCode").val(),
                LoaderId: Number($("#colLoaderId").val()),

                DrawerStatus: $("#colDrawerStatus").val(),
                GantryStatus: $("#colGantryStatus").val(),

                SetUnload: Number($("#colSetUnload").val()),
                ReelId: $("#colReelId").val(),
                ReelCode: $("#colReelCode").val(),
                ActualHeight: Number($("#colActualHeight").val()),

                CartesianRobotState: $("#colCartesianRobotState").val(),
                CartesianLocation: $("#colCartesianLocation").val(),

                RetrieveSlot: $("#colRetrieveSlot").val(),
                PutAwaySlot: $("#colPutAwaySlot").val(),
                SlotTake: Number($("#colSlotTake").val()),

                ReelIdC: $("#colReelIdC").val(),
                ReelCodeC: $("#colReelCodeC").val(),
                ActualHeightC: Number($("#colActualHeightC").val()),

                HalfPickMove: $("#colHalfPickMove").val() === "true",
                HalfPickMoveStep: $("#colHalfPickMoveStep").val(),
                HalfPlaceMove: $("#colHalfPlaceMove").val() === "true",
                HalfPlaceMoveStep: $("#colHalfPlaceMoveStep").val(),

                Col1TotalReels: Number($("#colCol1TotalReels").val()),
                Col2TotalReels: Number($("#colCol2TotalReels").val()),
                Col3TotalReels: Number($("#colCol3TotalReels").val()),
                Col4TotalReels: Number($("#colCol4TotalReels").val()),

                ColNum: colNum,
            }

            // console.log(data);

            $.ajax({
                url: '/api/PLCHubIn/UpdateRackJobJson',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                data: JSON.stringify(data),
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                },
                success: function (result) {
                    if (result.success == true) {
                        $("#jsonModal").modal("toggle");
                        getJson();
                    }
                    else {
                        console.log(result.errMessage);
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        /**
         * Appends a timestamped message to the HMI log display.
         */
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('system-log');
            if (!logContainer) return;

            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.classList.add('log-entry', `log-${type}`);
            logEntry.textContent = `[${timestamp}] ${message}`;

            logContainer.appendChild(logEntry);

            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function logMessage2(message, type = 'info') {
            const logContainer = document.getElementById('system-log-2');
            if (!logContainer) return;

            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.classList.add('log-entry', `log-${type}`);
            logEntry.textContent = `[${timestamp}] ${message}`;

            logContainer.appendChild(logEntry);

            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            const logContainer = document.getElementById('system-log');
            if (logContainer) {
                logContainer.innerHTML = '';
                logMessage("Log cleared by operator.", 'alert');
            }
        }

        function clearLog2() {
            const logContainer = document.getElementById('system-log-2');
            if (logContainer) {
                logContainer.innerHTML = '';
                logMessage2("Log cleared by operator.", 'alert');
            }
        }

        async function readyContinuos() {
            var data = await getJson();
            // console.log(data);

            if (data == true) {
                await getLoader($("#loader-input").val(), true);
                
                loadDBUpcoming();

                // console.log(sharedDrawerState);

                // updateSystemStatusUI();
                updateGantryUIState();
                updateCartesianUIState();

            }
        }

        // System Start Handler
        async function systemStart() {
            if (sharedDrawerState.systemRunning) return;

            // checking is loader valid and get loader info
            var loader = $("#loader-input").val();
            if (loader == undefined) {
                logMessage('Loader :: Please scan loader', 'alert');
                return;
            }
            if (loader == '') {
                logMessage('Loader :: Please scan loader', 'alert');
                return;
            }
            var ok = await getLoader(loader, false);
            if (ok == false) {
                return;
            }
            
            loadDBUpcoming();

            // 1. check Need SetUnload
            var setUnloadVal = $("#txtSetUnload").val();
            if (setUnloadVal == '0') {
                var chkMode = await loadPLCCheckMode();
                if (chkMode == false) {
                    return;
                }
                var setUnload = await loadPLCSetLoaderUnload();
                if (setUnload == false) {
                    return;
                }
            }

            // 2. Get PLC Current Column
            var col = await loadPLCGetCurrentColumn();
            if (col == false) {
                return;
            }

            // 3. Continue UI
            disableDivContent(false);

            updateActiveColumn(colNum);

            sharedDrawerState.systemRunning = true;
            updateSystemStatusUI();
            // logMessage("System Start command issued.", 'alert');

             updateJson();

            // 4. Continue
             gantryAutoTimer = setInterval(gantryAuto, 3000); //3 second workout
             cartesianAutoTimer = setInterval(cartesianAuto, 3000); //3 second workout

        }

        // System Continue Handler
        async function systemCont() {

            // 3. Continue UI
            disableDivContent(false);

            updateActiveColumn(colNum);

            sharedDrawerState.systemRunning = true;
            updateSystemStatusUI();

            // 4. Continue
             gantryAutoTimer = setInterval(gantryAuto, 3000); //3 second workout
             cartesianAutoTimer = setInterval(cartesianAuto, 3000); //3 second workout

        }

        // System Stop Handler
        function systemStop() {
            if (!sharedDrawerState.systemRunning) return;
            sharedDrawerState.systemRunning = false;
            updateSystemStatusUI();
            // logMessage("System Stop command issued. System idling.", 'alert');
            
            updateJson();

            clearInterval(gantryAutoTimer);
            clearInterval(cartesianAutoTimer);

        }

        // async function systemForceStop() {
        //     // if (!sharedDrawerState.systemRunning) return;

        //     swal.fire({
        //         title: "Are you sure want to force stop?",
        //         text: "",
        //         inputAttributes: {
        //             autocapitalize: 'off'
        //         },
        //         showCancelButton: true,
        //         confirmButtonText: 'ok',
        //         cancelButtonText: 'cancel',
        //         allowOutsideClick: false
        //     }).then(function(r) {
        //         if (r.isConfirmed == true) {
        //             // continue load
        //             logMessage(`Gantry and loader going end task.`, 'info');
        //             var rEnd = await loadPLCEndTask();
        //             if (rEnd == true) {
        //                 await loadDBStopUnload();
        //             }
        //             $('#jobDoneModal').modal('show');
        //         }
        //         else {
        //             return;
        //         }
        //     });


        // }
         
        // Function to update the main header status text and button states

        function updateSystemStatusUI() {
            const masterStatusSpan = document.getElementById('master-status');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const contBtn = document.getElementById('cont-btn');
            // const forcestopBtn = document.getElementById('forcestop-btn');

            if (sharedDrawerState.systemRunning) {
                masterStatusSpan.textContent = 'RUNNING';
                masterStatusSpan.style.color = 'var(--status-ok)';
                startBtn.disabled = true;
                contBtn.disabled = true;
                stopBtn.disabled = false;
                // forcestopBtn.disabled = false;
            } else {
                masterStatusSpan.textContent = 'STOPPED';
                masterStatusSpan.style.color = 'var(--status-alarm)';
                startBtn.disabled = false;
                contBtn.disabled = false;
                stopBtn.disabled = true;
                // forcestopBtn.disabled = true;
            }

            if (endTask == true) {
                startBtn.disabled = true;
                contBtn.disabled = true;
                masterStatusSpan.textContent = 'ALL DONE';
            }

        }

        // Helper function to update column status (Gantry side)
        function updateColumnStatus(colNo, count) {
            const colElement = document.getElementById('col-' + colNo);

            const countSpan = colElement.querySelector('.reel-count');
            countSpan.setAttribute('data-count', count);
            countSpan.textContent = count + ' left';

            if (count === 0) {
                colElement.setAttribute('data-status', 'empty');
            } else {
                colElement.setAttribute('data-status', 'full');
            }
        }

        // Function to update the active pick column visually AND move the loader track
        function updateActiveColumn(columnNumber) {
            // Remove active-pick class from previous columns
            document.querySelectorAll('.col').forEach(col => {
                col.classList.remove('active-pick');
            });

            const activeCol = document.getElementById('col-' + columnNumber);
            if (activeCol) {
                activeCol.classList.add('active-pick');
                // document.getElementById('next-pick-col').textContent = columnNumber;
            }

            // Animate the track to the correct position (existing animation logic)
            const loaderTrack = document.querySelector('.loader-track');
            loaderTrack.classList.remove('pos-col-1', 'pos-col-2', 'pos-col-3', 'pos-col-4');
            loaderTrack.classList.add(`pos-col-${columnNumber}`);

            // // Ensure dimming is off by default when just indexing
            // loaderTrack.classList.remove('picking-dim');
        }

        function updateGantryUIState() {

            // const pickBtn = document.getElementById('btnPick');
            // const placeBtn = document.getElementById('btnPlace');
            const holdStatusBanner = document.getElementById('gantry-hold-status');
            const gantryHead = document.querySelector('.gantry-head');

            // Reset visibility/disability first
            // pickBtn.disabled = false;
            // placeBtn.disabled = false;
            holdStatusBanner.style.display = 'none';

            switch (sharedDrawerState.gantrySequenceState) {
                case 'Returning':
                    // pickBtn.disabled = false;
                    gantryHead.setAttribute('data-position', 'loader'); // Start moving right
                    break;
                case 'PickedAndHolding':
                    // pickBtn.disabled = true; // Cannot start new cycle
                    // placeBtn.disabled = false; // Can now continue
                    gantryHead.setAttribute('data-position', 'pickup'); // Ensure it stays at loader point
                    gantryHead.setAttribute('data-has-reel', 'true'); // Visually show it holding
                    holdStatusBanner.style.display = 'block';
                    break;
                case 'Placing':
                    // pickBtn.disabled = true;
                    // placeBtn.disabled = true;
                    break;
            }

        }

        function updateDrawerStatus(status, text) {
            const drawer = document.querySelector('.drawer');
            drawer.setAttribute('data-status', status);
            document.getElementById('drawer-status-text').textContent = text;
        }

        function updateCartesianUIState() {
            document.querySelectorAll('.rack-area').forEach(area => {
                area.classList.remove('active');
            });

            if (sharedDrawerState.cartesianLocation === 'left') {
                document.querySelector('.left-rack').classList.add('active');
                // document.getElementById('left-status').textContent = "ROBOT PRESENT";
                // document.getElementById('right-status').textContent = "Status: IDLE";
            } else if (sharedDrawerState.cartesianLocation === 'right') {
                document.querySelector('.right-rack').classList.add('active');
                // document.getElementById('right-status').textContent = "ROBOT PRESENT";
                // document.getElementById('left-status').textContent = "Status: IDLE";
            } else {
                $("#left-input").val('');
                $("#right-input").val('');
                // document.getElementById('left-status').textContent = "Status: IDLE";
                // document.getElementById('right-status').textContent = "Status: IDLE";
            }

            document.getElementById('cartesian-state-simple').textContent = sharedDrawerState.cartesianRobotState;
        }

        function disableDivContent(status) {
            const div2 = document.getElementById('gantry-session');
            if (div2) {
                const interactiveElements = div2.querySelectorAll('button'); // input, select, textarea,
                interactiveElements.forEach(element => {
                    element.setAttribute('disabled', status);
                    if (status == false) {
                        element.removeAttribute('disabled');
                    }
                });
            }

            const div = document.getElementById('cartesian-session');
            if (div) {
                const interactiveElements = div.querySelectorAll('button'); // input, select, textarea,
                interactiveElements.forEach(element => {
                    element.setAttribute('disabled', status);
                    if (status == false) {
                        element.removeAttribute('disabled');
                    }
                });
            }

            if (status == true) {
                const links = document.querySelectorAll('a');
                links.forEach(link => {
                  // Store the original href in a data attribute
                  link.dataset.originalHref = link.href;
                  // Remove the href attribute to prevent navigation
                  link.removeAttribute('href');
                  // Optionally, add a class for visual styling and set aria-disabled for accessibility
                  link.classList.add('disabled-link');
                  link.setAttribute('aria-disabled', 'true');
                });
            }
            else {
                const links = document.querySelectorAll('a');
                links.forEach(link => {
                  // Restore the original href from the data attribute
                  if (link.dataset.originalHref) {
                    link.href = link.dataset.originalHref;
                    delete link.dataset.originalHref; // Clean up the data attribute
                  }
                  // Remove the styling class and aria-disabled attribute
                  link.classList.remove('disabled-link');
                  link.removeAttribute('aria-disabled');
                });
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ----------- HMI Action
        function updateJson() {
            var data = {
                SystemStart: sharedDrawerState.systemRunning,

                LoaderCode: $("#loader-input").val(),
                LoaderId: Number($("#txtLoaderId").val()),

                DrawerStatus: sharedDrawerState.drawerStatus,
                GantryStatus: sharedDrawerState.gantrySequenceState,

                SetUnload: Number($("#txtSetUnload").val()),
                ReelId: $("#txtReelId").val(),
                ReelCode: $("#txtReelCode").val(),
                ActualHeight: Number($("#txtActHeight").val()),

                CartesianRobotState: sharedDrawerState.cartesianRobotState,
                CartesianLocation: sharedDrawerState.cartesianLocation,

                RetrieveSlot: $("#txtRetrieveSlot").val(),
                PutAwaySlot: $("#txtPutSlot").val(),
                SlotTake: Number($("#txtPutSlotTake").val()),

                ReelIdC: $("#txtReelIdC").val(),
                ReelCodeC: $("#txtReelCodeC").val(),
                ActualHeightC: Number($("#txtActHeightC").val()),

                HalfPickMove: halfPickMove,
                HalfPickMoveStep: halfPickMoveStep,
                HalfPlaceMove: halfPlaceMove,
                HalfPlaceMoveStep: halfPlaceMoveStep,

                Col1TotalReels: Number($("#txtCol1TotalReels").val()),
                Col2TotalReels: Number($("#txtCol2TotalReels").val()),
                Col3TotalReels: Number($("#txtCol3TotalReels").val()),
                Col4TotalReels: Number($("#txtCol4TotalReels").val()),

                ColNum: colNum,
            }

            $.ajax({
                url: '/api/PLCHubIn/UpdateRackJobJson',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                data: JSON.stringify(data),
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                },
                success: function (result) {
                    if (result.success == true) {
                    }
                    else {
                        console.log(result.errMessage);
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        async function getJson() {
            var fResult = false;

            await $.ajax({
                url: '/api/PLCHubIn/GetRackJobJson',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                },
                success: function (result) {
                    sharedDrawerState.systemRunning = result.data.systemRunning;

                    sharedDrawerState.drawerStatus = result.data.drawerStatus;
                    sharedDrawerState.gantrySequenceState = result.data.gantryStatus;

                    $("#loader-input").val(result.data.loaderCode);
                    $("#txtLoaderId").val(result.data.loaderId);

                    $("#txtSetUnload").val(result.data.setUnload);
                    $("#txtReelId").val(result.data.reelId);
                    $("#txtReelCode").val(result.data.reelCode);
                    $("#txtActHeight").val(result.data.actualHeight);

                    sharedDrawerState.cartesianRobotState = result.data.cartesianRobotState;
                    sharedDrawerState.cartesianLocation = result.data.cartesianLocation;

                    $("#txtRetrieveSlot").val(result.data.retrieveSlot);
                    $("#txtPutSlot").val(result.data.putAwaySlot);
                    $("#txtPutSlotTake").val(result.data.slotTake);

                    $("#txtReelIdC").val(result.data.reelIdC);
                    $("#txtReelCodeC").val(result.data.reelCodeC);
                    $("#txtActHeightC").val(result.data.actualHeightC);

                    halfPickMove = result.data.HalfPickMove;
                    halfPickMoveStep = result.data.halfPickMoveStep;
                    halfPlaceMove = result.data.halfPlaceMove;
                    halfPlaceMoveStep = result.data.halfPlaceMoveStep;

                    colNum = result.data.colNum;

                    fResult = true;

                    return fResult;
                },
                error: function (error) {
                    console.log(error);
                }
            });

            return fResult;
        }

        // ----------- Action (Auto Mode)
        function gantryAuto() {
            if (endTask == true) { return; }
            console.log("AutoGantry");
            const chkAutoRun = document.getElementById('chkAutoRun');
            if (chkAutoRun.checked) {
                // 1. if gantry no pick then just pick
                if (sharedDrawerState.systemRunning == true && sharedDrawerState.gantrySequenceState == "Returning" && inPickMove == false && inPlaceMove == false) {
                    var bal = Number($("#txtCol1TotalReels").val());
                    bal = bal + Number($("#txtCol2TotalReels").val());
                    bal = bal + Number($("#txtCol3TotalReels").val());
                    bal = bal + Number($("#txtCol4TotalReels").val());
                    if (bal == 0) {
                        return;
                    }
                    startPick();
                }

                // 2. if gantry picked then just place
                if (sharedDrawerState.systemRunning == true && sharedDrawerState.gantrySequenceState == "PickedAndHolding" && sharedDrawerState.drawerStatus == "Drawer" && inPickMove == false && inPlaceMove == false) {
                    startPlace();
                }
            }
        }

        function cartesianAuto() {
            if (endTask == true) { return; }
            console.log("AutoCartesian");
            const chkAutoRun = document.getElementById('chkAutoRun');
            if (chkAutoRun.checked) {
                // 1. if no drawer just take (reelId MUST have first cause need get actual height)
                 var actH = $("#txtActHeight").val();
                if (sharedDrawerState.systemRunning == true && sharedDrawerState.drawerStatus == "None" && actH != "0" && inRetrieveMove == false && inPutAwayMove == false) {
                    startRetrieve();
                }

                // 2. if have drawer and placed then just put away
                 var actHC = $("#txtActHeightC").val();
                if (sharedDrawerState.systemRunning == true && sharedDrawerState.drawerStatus == "Placed" && actHC != "0" && inRetrieveMove == false && inPutAwayMove == false) {
                    startPutAway();
                }

            }
        }

        // ----------- Action
        // Gantry + Loader Start Pick
        async function startPick() {
            if (inPickMove == true) {
                return;
            }
            if (sharedDrawerState.systemRunning != true) {
                logMessage(`System not yet start.`, 'alert');
                return;
            }
            if (sharedDrawerState.gantrySequenceState != "Returning") {
                logMessage(`Drawer is ${sharedDrawerState.gantrySequenceState}, please check.`, 'alert');
                return;
            }
            var bal = Number($("#txtCol1TotalReels").val());
            bal = bal + Number($("#txtCol2TotalReels").val());
            bal = bal + Number($("#txtCol3TotalReels").val());
            bal = bal + Number($("#txtCol4TotalReels").val());
            if (bal == 0) {
                logMessage(`No Reel to unload.`, 'info');
                return;
            }

            logMessage(`Gantry cycle started: Picking from Column ${colNum}.`, 'info');
            inPickMove = true;

            var chkGantry = await loadPLCCheckUnlodingStatus();
            if (chkGantry == false) {
                sharedDrawerState.gantrySequenceState = 'Returning';
                updateGantryUIState();
                inPickMove = false;
                return;
            }

            var turn = await turnCol(1);
            if (turn == false) {
                sharedDrawerState.gantrySequenceState = 'Returning';
                updateGantryUIState();
                inPickMove = false;
                return;
            }

            if (halfPickMove == false || (halfPickMove == true && halfPickMoveStep<=3)) {
                var setScan = await loadPLCStartBarcodeScanner();
                if (setScan == false) {
                    sharedDrawerState.gantrySequenceState = 'Returning';
                    updateGantryUIState();
                    inPickMove = false;
                    halfPickMove = true;
                    halfPickMoveStep = 3;
                    updateJson();
                    return;
                }
                await delay(3000);
            }

            if (halfPickMove == false || (halfPickMove == true && halfPickMoveStep<=4)) {
                var getReelInfo = await loadPLCScanReelID();
                if (getReelInfo == false) {
                    sharedDrawerState.gantrySequenceState = 'Returning';
                    updateGantryUIState();
                    inPickMove = false;
                    halfPickMove = true;
                    halfPickMoveStep = 4;
                    updateJson();
                    return;
                }
                attemptsPick = 1;
            }
            updateJson();

            if (halfPickMove == false || (halfPickMove == true && halfPickMoveStep<=5)) {
                var setH = await loadPLCSetActualHeight();
                if (setH == false) {
                    sharedDrawerState.gantrySequenceState = 'Returning';
                    updateGantryUIState();
                    inPickMove = false;
                    halfPickMove = true;
                    halfPickMoveStep = 5;
                    updateJson();
                    return;
                }
            }

            if (halfPickMove == false || (halfPickMove == true && halfPickMoveStep<=6)) {
                var chkPicked = await loadPLCGetPickStatus();
                if (chkPicked == false) {
                    sharedDrawerState.gantrySequenceState = 'Returning';
                    updateGantryUIState();
                    inPickMove = false;
                    halfPickMove = true;
                    halfPickMoveStep = 6;
                    updateJson();
                    return;
                }
            }
            
            var chkDB = await loadDBLoaderCount();
            updateColCount();

            sharedDrawerState.gantrySequenceState = 'PickedAndHolding';
            updateGantryUIState();
            logMessage(`Gantry cycle end: Picked from Column ${colNum}.`, 'info');
            inPickMove = false;
            halfPickMove = false;
            halfPickMoveStep = 1;

            updateJson();
            loadDBUpcoming();
        }

        // Gantry Start Place
        async function startPlace() {
            if (inPlaceMove == true) {
                return;
            }
            if (sharedDrawerState.systemRunning != true) {
                logMessage(`System not yet start.`, 'alert');
                return;
            }
            if (sharedDrawerState.drawerStatus != "Drawer") {
                logMessage(`Drawer is ${sharedDrawerState.drawerStatus}, please check.`, 'alert');
                return;
            }

            // Update the state to 'Picking', which triggers the dimming effect via updateGantryUIState
            sharedDrawerState.gantrySequenceState = 'Placing';
            updateGantryUIState();
            logMessage(`Gantry cycle started: Placing on drawer.`, 'info');
            inPlaceMove = true;

            if (halfPlaceMove == false) {
                attemptsPlace = 1;
            }
            var setPlace = await loadPLCPlaceReel();
            if (setPlace == false) {
                sharedDrawerState.gantrySequenceState = 'PickedAndHolding';
                updateGantryUIState();
                inPlaceMove = false;
                return;
            }
            await delay(3000);

            if (halfPlaceMove == false || (halfPlaceMove == true && halfPlaceMoveStep<=2)) {
                var chkPlaced = await loadPLCGetPlaceStatus();
                if (chkPlaced == false) {
                    sharedDrawerState.gantrySequenceState = 'PickedAndHolding';
                    updateGantryUIState();
                    inPlaceMove = false;
                    halfPlaceMove = true;
                    halfPlaceMoveStep = 2;
                    updateJson();
                    return;
                }
            }

            sharedDrawerState.drawerStatus = "Placed";
            updateDrawerStatus('Placed', 'Placed');

            sharedDrawerState.gantrySequenceState = 'Returning';
            updateGantryUIState();
            logMessage(`Gantry cycle end: Placed done.`, 'info');

            inPlaceMove = false;
            halfPlaceMove = false;
            halfPlaceMoveStep = 1;
            
            updateJson();
        }

        // Cartesian Start Retrieve Empty Drawer
        async function startRetrieve() {
            if (inRetrieveMove == true) {
                return;
            }
            if (sharedDrawerState.systemRunning != true) {
                logMessage(`System not yet start.`, 'alert');
                return;
            }
            if (sharedDrawerState.drawerStatus != "None") {
                logMessage2(`Drawer is ${sharedDrawerState.drawerStatus}, please check.`, 'alert');
                return;
            }

            var actH = $("#txtActHeight").val();
            if (actH == "0") {
                return;
            }

            sharedDrawerState.cartesianRobotState = 'Retrieving';
            logMessage2(`Cartesian cycle started: Retrieve Empty Drawer.`, 'info');
            inRetrieveMove = true;

            var getSlotCode = await loadPLCGetEmptyTraySlot();
            if (getSlotCode == false) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inRetrieveMove = false;
                return;
            }

            changeTakeSlot = false;

            updateCartesianUIState();
            var getSlot = await loadPLCTakeEmptyTray();
            if (getSlot == false) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inRetrieveMove = false;
                return;
            }
            await delay(5000);

            var chkStatus = await loadPLCGetRetrieveTrayStatus();
            if (chkStatus == -1) {
                // sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                // inRetrieveMove = false;
                // changeTakeSlot = true;

                // if (attemptsRetrieve > 5) {
                //     logMessage('Retrieve Empty Drawer :: Tried ' + (attemptsRetrieve - 1) + ', auto stop now.', 'info');
                //     document.getElementById('chkAutoRun').checked = false;
                //     return false;
                // }
                logMessage('Retrieve Empty Drawer :: Please check catesian, auto stop now.', 'info');
                document.getElementById('chkAutoRun').checked = false;
                return;
            }
            else if (chkStatus == 1) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inRetrieveMove = false;
                changeTakeSlot = true;

                if (attemptsRetrieve > 5) {
                    logMessage('Retrieve Empty Drawer :: Tried ' + (attemptsRetrieve - 1) + ', auto stop now.', 'info');
                    document.getElementById('chkAutoRun').checked = false;
                    return false;
                }

                return;
            }


            attemptsRetrieve = 1;

            sharedDrawerState.drawerStatus = "Drawer";
            updateDrawerStatus('Drawer', 'Empty Drawer');

            sharedDrawerState.cartesianRobotState = 'Ready';
            sharedDrawerState.cartesianLocation = '';
            updateCartesianUIState();
            updateDrawerStatus('Drawer', 'Empty Drawer Ready');
            logMessage2(`Cartesian cycle end: Retrieved.`, 'info');
            inRetrieveMove = false;

            updateJson();
        }

        // Cartesian Start Put Away
        async function startPutAway() {
            if (inPutAwayMove == true) {
                return;
            }
            if (sharedDrawerState.systemRunning != true) {
                logMessage(`System not yet start.`, 'alert');
                return;
            }
            if (sharedDrawerState.drawerStatus != "Placed") {
                logMessage2(`Drawer is ${sharedDrawerState.drawerStatus}, please check.`, 'alert');
                return;
            }

            var actH = $("#txtActHeightC").val();
            if (actH == "0") {
                return;
            }

            sharedDrawerState.cartesianRobotState = 'In Put Away';
            logMessage2(`Cartesian cycle started: Put Away Reel.`, 'info');
            inPutAwayMove = true;

            var getSlotCode = await loadPLCGetSlot();
            if (getSlotCode == false) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inPutAwayMove = false;
                return;
            }

            changePutSlot = false;

            updateCartesianUIState();
            var getSlot = await loadPLCPutAway();
            if (getSlot == false) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inPutAwayMove = false;
                return;
            }
            await delay(5000);

            var chkStatus = await loadPLCGetPutAwayStatus();
            if (chkStatus == false) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inPutAwayMove = false;
                changePutSlot = true;

                if (attemptsPutAway > 5) {
                    logMessage('Put Away Reel :: Tried ' + (attemptsPutAway - 1) + ', auto stop now.', 'info');
                    document.getElementById('chkAutoRun').checked = false;
                    return false;
                }

                return;
            }

            attemptsPutAway = 1;

            var chkDB = await loadDBReelRack();
            removeDBUpcoming();

            sharedDrawerState.cartesianRobotState = 'Ready';
            sharedDrawerState.cartesianLocation = '';
            updateCartesianUIState();

            sharedDrawerState.drawerStatus = "None";
            updateDrawerStatus('None', 'No Drawer');
            logMessage2(`Cartesian cycle end: Put Away Done.`, 'info');
            inPutAwayMove = false;

            // means all is out
            var bal = Number($("#txtCol1TotalReels").val());
            bal = bal + Number($("#txtCol2TotalReels").val());
            bal = bal + Number($("#txtCol3TotalReels").val());
            bal = bal + Number($("#txtCol4TotalReels").val());
            if (bal == 0 && sharedDrawerState.gantrySequenceState == "Returning" && sharedDrawerState.cartesianRobotState == 'Ready') {
                logMessage(`Gantry and loader going end task.`, 'info');
                var rEnd = await loadPLCEndTask();
                if (rEnd == true) {
                    await loadDBStopUnload();
                }
                $('#jobDoneModal').modal('show');
            }

            updateJson();
        }


        // ----------- Action :: retry
        async function retry_PickStatus() {
            var chkPicked = await loadPLCGetPickStatus();
            if (chkPicked == false) {
                sharedDrawerState.gantrySequenceState = 'Returning';
                updateGantryUIState();
                inPickMove = false;
                halfPickMove = true;
                halfPickMoveStep = 6;
                updateJson();
                return;
            }

            var chkDB = await loadDBLoaderCount();
            updateColCount();

            sharedDrawerState.gantrySequenceState = 'PickedAndHolding';
            updateGantryUIState();
            logMessage(`Gantry cycle end: Picked from Column ${colNum}.`, 'info');
            inPickMove = false;
            halfPickMove = false;
            halfPickMoveStep = 1;

            updateJson();
            loadDBUpcoming();
        }

        async function retry_PlaceStatus() {
            var chkPlaced = await loadPLCGetPlaceStatus();
            if (chkPlaced == false) {
                sharedDrawerState.gantrySequenceState = 'PickedAndHolding';
                updateGantryUIState();
                inPlaceMove = false;
                halfPlaceMove = true;
                halfPlaceMoveStep = 2;
                updateJson();
                return;
            }

            sharedDrawerState.drawerStatus = "Placed";
            updateDrawerStatus('Placed', 'Placed');

            sharedDrawerState.gantrySequenceState = 'Returning';
            updateGantryUIState();
            logMessage(`Gantry cycle end: Placed done.`, 'info');
            
            inPlaceMove = false;
            halfPlaceMove = false;
            halfPlaceMoveStep = 1;

            updateJson();
        }

        async function retry_RetrieveStatus() {
            var chkStatus = await loadPLCGetRetrieveTrayStatus();
            if (chkStatus == -1) {
                // sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                // inRetrieveMove = false;
                // changeTakeSlot = true;

                // if (attemptsRetrieve > 5) {
                //     logMessage('Retrieve Empty Drawer :: Tried ' + (attemptsRetrieve - 1) + ', auto stop now.', 'info');
                //     document.getElementById('chkAutoRun').checked = false;
                //     return false;
                // }
                logMessage('Retrieve Empty Drawer :: Please check catesian, auto stop now.', 'info');
                document.getElementById('chkAutoRun').checked = false;
                return;
            }
            else if (chkStatus == 1) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inRetrieveMove = false;
                changeTakeSlot = true;
                return;
            }

            attemptsRetrieve = 1;

            sharedDrawerState.drawerStatus = "Drawer";
            updateDrawerStatus('Drawer', 'Empty Drawer');

            sharedDrawerState.cartesianRobotState = 'Ready';
            sharedDrawerState.cartesianLocation = '';
            updateCartesianUIState();
            updateDrawerStatus('Drawer', 'Empty Drawer Ready');
            logMessage2(`Cartesian cycle end: Retrieved.`, 'info');
            inRetrieveMove = false;

            updateJson();
        }

        async function retry_PutAwayStatus() {
            var chkStatus = await loadPLCGetPutAwayStatus();
            if (chkStatus == false) {
                sharedDrawerState.cartesianRobotState = 'Retrieve Failure';
                inPutAwayMove = false;
                changePutSlot = true;
                return;
            }

            var chkDB = await loadDBReelRack();
            removeDBUpcoming();

            sharedDrawerState.cartesianRobotState = 'Ready';
            sharedDrawerState.cartesianLocation = '';
            updateCartesianUIState();

            sharedDrawerState.drawerStatus = "None";
            updateDrawerStatus('None', 'No Drawer');
            logMessage2(`Cartesian cycle end: Put Away Done.`, 'info');
            inPutAwayMove = false;

            updateJson();
        }


        // ----------- Database
        function updateColCount() {
            var fResult = false;

            var bal = 0;
            if (Number(colNum) == 1) {
                bal = Number($("#txtCol1TotalReels").val());
                bal = bal - 1;
                $("#txtCol1TotalReels").val(bal);

                updateColumnStatus(1, bal);
            }
            if (Number(colNum) == 2) { 
                bal = Number($("#txtCol2TotalReels").val());
                bal = bal - 1;
                $("#txtCol2TotalReels").val(bal);

                updateColumnStatus(2, bal);
            }
            if (Number(colNum) == 3) { 
                bal = Number($("#txtCol3TotalReels").val());
                bal = bal - 1;
                $("#txtCol3TotalReels").val(bal);

                updateColumnStatus(3, bal);
            }
            if (Number(colNum) == 4) {
                bal = Number($("#txtCol4TotalReels").val());
                bal = bal - 1;
                $("#txtCol4TotalReels").val(bal);

                updateColumnStatus(4, bal);
            }

            return fResult;
        }

        async function loadDBLoaderCount() {

            var loaderId = $("#txtLoaderId").val();
            var reelId = $("#txtReelId").val();
            var fResult = -1;

            if (reelId == '') { return 0; }

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/UpdateLoaderCount/" + loaderId + "/" + colNum + "/" + reelId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('4::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = result.data;
                        logMessage('Update DB Loader Count :: Done ', 'info');
                    }
                    else {
                        logMessage('Update DB Loader Count :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Update DB Loader Count :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadDBReelRack() {

            var reelIdC = $("#txtReelIdC").val();
            var sCode = $("#txtPutSlot").val();
            var sTake = $("#txtPutSlotTake").val();
            var fResult = false;

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/UpdateReelRack/" + reelIdC + "/" + sCode + "/" + sTake,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('4::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage('Update DB Rack :: Done ', 'info');

                        $("#txtRetrieveSlot").val('');
                        $("#txtPutSlot").val('');
                        $("#txtPutSlotTake").val('');

                        $("#txtReelIdC").val('');
                        $("#txtReelCodeC").val('');
                        $("#txtActHeightC").val('0');

                    }
                    else {
                        logMessage('Update DB Rack :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Update DB Rack :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadDBStopUnload() {

            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/StopUnload/" + qId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('10::' + JSON.stringify(result));
                    // swal.close();
                    return true;
                },
                error: function (error) {
                    logMessage('End Loader :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        function loadDBUpcoming() {
            
            var loaderId = $("#txtLoaderId").val();
            const count = document.querySelectorAll('.reel-card').length;

            $.ajax({
                url: "/api/PLCHubIn/GetUpcomingReels/" + loaderId + "/" + count,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log(result);

                    if (result.totalRecords > 0) {
                        const parentDiv = document.getElementById("system-log-3");
                        for (var i = 0; i < result.data.length; i++) {
                            let id = result.data[i].reelCode;
                            let code = result.data[i].itemCode;
                            let qty = result.data[i].qty;

                            const newDiv = ` <div class="reel-card">
                                                <div class="reel-info">
                                                    <p>${id}</p>
                                                    <p>Item: ${code}</p>
                                                    <p>Qty: ${qty}</p>
                                                </div>
                                            </div>`;
                            parentDiv.innerHTML += newDiv;
                        }
                    }

                    return true;
                },
                error: function (error) {
                    logMessage('End Loader :: ' + error.val, 'alert');
                }
            });

        }

        function removeDBUpcoming() {
            const parentDiv = document.getElementById("system-log-3");

            const firstDivToRemove = parentDiv.querySelector('.reel-card:first-child'); // Replace 'childClassName' with the target class name

            // 3. Check if the element exists and then remove it
            if (firstDivToRemove) {
                firstDivToRemove.classList.add('fade-out');

                // 2. Wait for the animation to finish (500ms in this example) and then remove the element
                setTimeout(() => {
                    firstDivToRemove.remove(); // The .remove() method is simple and widely supported
                }, 500); // The delay must match the CSS transition duration
            }
        }

        // ----------- Gantry
        async function getLoader(code, isCont) {
            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/StartUnload/" + code + "/" + qId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                    Swal.fire({
                        text: 'Please Wait',
                        width: '300px',

                        allowEscapeKey: false,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                    Swal.showLoading()
                },
                success: function (result) {
                    // console.log(result);
                    swal.close();

                    if (result.success == true) {
                        fResult = true;

                        $("#txtLoaderId").val(result.data.loaderInfo.loader_Id);

                        updateColumnStatus(1, result.data.loaderInfo.col1TotalReels);
                        updateColumnStatus(2, result.data.loaderInfo.col2TotalReels);
                        updateColumnStatus(3, result.data.loaderInfo.col3TotalReels);
                        updateColumnStatus(4, result.data.loaderInfo.col4TotalReels);

                        $("#txtCol1TotalReels").val(result.data.loaderInfo.col1TotalReels);
                        $("#txtCol2TotalReels").val(result.data.loaderInfo.col2TotalReels);
                        $("#txtCol3TotalReels").val(result.data.loaderInfo.col3TotalReels);
                        $("#txtCol4TotalReels").val(result.data.loaderInfo.col4TotalReels);

                        logMessage('Loader :: Done check ' + code, 'info');
                    }
                    else {
                        updateColumnStatus(1, 0);
                        updateColumnStatus(2, 0);
                        updateColumnStatus(3, 0);
                        updateColumnStatus(4, 0);

                        $("#txtCol1TotalReels").val(0);
                        $("#txtCol2TotalReels").val(0);
                        $("#txtCol3TotalReels").val(0);
                        $("#txtCol4TotalReels").val(0);

                        logMessage('Loader :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Loader :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCCheckMode() {

            var loaderId = $("#txtLoaderId").val();
            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/GetLoaderMode/" + loaderId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('2::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage('Loader Mode :: Auto ', 'info');
                    }
                    else {
                        logMessage('Loader Mode :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Set Unload :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCSetLoaderUnload() {

            var loaderId = $("#txtLoaderId").val();
            var fResult = false;

            var setUnloadVal = $("#txtSetUnload").val();
            if (setUnloadVal == '1') {
                return;
            }

            await $.ajax({
                url: "/api/PLCHubIn/SetLoaderUnload/" + loaderId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    console.log('2::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;

                        $("#txtSetUnload").val("1");

                        logMessage('Set Unload :: Done ', 'info');
                    }
                    else {
                        logMessage('Set Unload :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Set Unload :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCCheckUnlodingStatus() {

            var loaderId = $("#txtLoaderId").val();
            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/GetUnlodingStatus/" + loaderId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    if (result.success == true) {
                        logMessage('Check Unload :: OK ', 'info');

                        fResult = true;
                    }
                    else {
                        if (result.data[0] != "2") {
                            logMessage('Check Unload :: Err Gripper ' + result.errMessage, 'alert');
                        }
                        if (result.data[1] != "16") {
                            logMessage('Check Unload :: Err Fork ' + result.errMessage, 'alert');
                        }
                    }
                },
                error: function (error) {
                    logMessage('Check Unload :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCStartBarcodeScanner() {

            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/StartBarcodeScanner/",
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('2::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        logMessage('Start Scan :: Done ', 'info');

                        fResult = true;
                    }
                    else {
                        logMessage('Start Scan :: Err Gripper ' + result.errMessage, 'alert');
                        // $('#pSetUnload').html('Set Unload : <span class="error-message" id="errSetUnload"> ' + result.errMessage + ' </span>');
                    }
                },
                error: function (error) {
                    logMessage('Start Scan :: ' + error.val, 'alert');
                    // $('#pSetUnload').html('Set Unload : <span class="error-message" id="errSetUnload"> ' + error.val + ' </span>');
                }
            });

            return fResult;
        }

        async function loadPLCScanReelID() {

            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/GetReelID/",
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    if (result.data.successReel) {
                        fResult = true;

                        $("#txtReelId").val(result.data.reel_Id);
                        $("#txtReelCode").val(result.data.reelCode);
                        $("#txtActHeight").val(result.data.actualHeight);

                        $('#txtReel').html('Reel : ' + result.data.reelCode);

                        logMessage('Get Scanned :: OK ' + result.data.scannedBarcode, 'info');
                        logMessage('Get Scanned :: Item Code ' + result.data.itemCode, 'info');
                        logMessage('Get Scanned :: Reel Id ' + result.data.reel_Id, 'info');
                        logMessage('Get Scanned :: Reel Code ' + result.data.reelCode, 'info');
                        logMessage('Get Scanned :: Actual Height ' + result.data.actualHeight, 'info');
                    }
                    else {
                        logMessage('Get Scanned :: ' + result.data.errMessageReel, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Get Scanned :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCSetActualHeight() {

            var loaderId = $("#txtLoaderId").val();
            var actH = $("#txtActHeight").val();
            var fResult = false;

            if (attemptsPick > 3) {
                logMessage('Set Height :: Tried ' + attemptsPick + ', auto stop now.', 'info');
                document.getElementById('chkAutoRun').checked = false;
                attemptsPick = 1;
                return false;
            }
            attemptsPick += 1;

            await $.ajax({
                url: "/api/PLCHubIn/SetActualHeight/" + loaderId + "/" + actH,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    if (result.success == true) {
                        fResult = true;

                        logMessage('Set Height :: Done ' + result.data.scannedBarcode, 'info');
                    }
                    else {
                        logMessage('Set Height :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Set Height :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCGetPickStatus() {

            var fResult = false;

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/GetPickStatus/",
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('3::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage('Pick Status :: OK ', 'info');
                    }
                    else {
                        logMessage('Pick Status :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Pick Status :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCPlaceReel() {

            var fResult = false;

            if (attemptsPlace > 3) {
                logMessage('Place :: Tried ' + attemptsPlace + ', auto stop now.', 'info');
                document.getElementById('chkAutoRun').checked = false;
                attemptsPlace = 1;
                return false;
            }
            attemptsPlace += 1;

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/PutReelOnTray/",
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('4::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage('Place :: Done ', 'info');
                    }
                    else {
                        logMessage('Place :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Place :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCGetPlaceStatus() {

            var fResult = false;

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/GetPlaceStatus/",
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('4::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage('Place Status :: OK ', 'info');

                        $("#txtReelIdC").val($("#txtReelId").val());
                        $("#txtReelCodeC").val($("#txtReelCode").val());
                        $("#txtActHeightC").val($("#txtActHeight").val());

                        $("#txtReelId").val('');
                        $("#txtReelCode").val('');
                        $("#txtActHeight").val('0');

                        $('#txtReel').html('Reel : - ');
                    }
                    else {
                        logMessage('Place Status :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Place Status :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        // ----------- Loader
        async function loadPLCGetCurrentColumn() {

            var loaderId = $("#txtLoaderId").val();
            var fResult = false;

            await $.ajax({
                url: "/api/PLCLoader/GetCurrentColumn/" + loaderId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('2.3::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        colNum = result.data;
                        fResult = true;
                        logMessage('PLC Column :: ' + result.data, 'info');
                    }
                    else {
                        logMessage('PLC Column :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('PLC Column :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function turnCol(idx) {
            var fResult = false;

            var loaderId = $("#txtLoaderId").val();

            var bal = $("#txtCol1TotalReels").val();
            if (Number(colNum) == 2) { bal = $("#txtCol2TotalReels").val(); }
            if (Number(colNum) == 3) { bal = $("#txtCol3TotalReels").val(); }
            if (Number(colNum) == 4) { bal = $("#txtCol4TotalReels").val(); }
            // $('#txtBal').html(bal);

            if (bal > 0) {
                return true;
            }
            else {
                var nextCol = 2;
                if (Number($("#txtCol4TotalReels").val()) > 0) { nextCol = 4; }
                if (Number($("#txtCol3TotalReels").val()) > 0) { nextCol = 3; }
                if (Number($("#txtCol2TotalReels").val()) > 0) { nextCol = 2; }

                if (Number(colNum) < Number(nextCol)) {

                    var setE = true;
                    if (idx <= 1) {
                        setE = await loadPLCSetColumnEmpty(loaderId, Number(colNum));
                        await delay(8000);
                    }
                    if (setE == false) {
                        return fResult;
                    }

                    var getR = true;
                    if (idx <= 2) {
                        getR = await loadPLCReadyStatus(loaderId);
                    }
                    if (getR == false) {
                        return fResult;
                    }

                    var getT = true;
                    if (idx <= 3) {
                        getT = await loadPLCTurn(loaderId, Number(nextCol));
                    }
                    if (getT == false) {
                    }
                    else {
                        var delayT = 5000 * (nextCol - 1);
                        await delay(delayT);

                        var chkGripper2 = await loadPLCCheckUnlodingStatus(loaderId);
                        // console.log('R2.32::' + chkGripper2);
                        if (chkGripper2 == true) {
                            return true;
                        }
                    }
                }
            }
            return fResult;
        }

        async function loadPLCSetColumnEmpty(loaderId, curCol) {

            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/SetColumnEmpty/"+ loaderId + "/" + curCol,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('2::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage('Set Empty Column [' + curCol + '] :: Done ', 'info');
                    }
                    else {
                        logMessage('Set Empty Column [' + curCol + '] :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Set Empty Column [' + curCol + '] :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCReadyStatus(loaderId) {

            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/GetReadyTurnStatus/"+ loaderId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('2::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage('Status Ready to Turn Column :: OK ', 'info');
                    }
                    else {
                        logMessage('Status Ready to Turn Column :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Status Ready to Turn Column :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCTurn(loaderId, nextCol) {

            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/SetTurnColumn/"+ loaderId + "/" + nextCol,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('2::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        colNum = nextCol;
                        updateActiveColumn(colNum);
                        fResult = true;
                        logMessage('Turn Column :: OK ', 'info');
                    }
                    else {
                        logMessage('Turn Column :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage('Turn Column :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCEndTask() {

            var loaderId = $("#txtLoaderId").val();
            var fResult = false;

            for (var iC = Number(colNum); iC <= 4; iC++) {
                await delay(1000);
                var setE = await loadPLCSetColumnEmpty(loaderId, Number(iC));
                console.log('R5.2::' + setE);
            }

            await $.ajax({
                url: "/api/PLCHubIn/UnloadEndTask/" + loaderId,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('10::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        endTask = true;
                        fResult = true;
                        logMessage('End Loader :: OK ', 'info');
                        systemStop();
                    }
                },
                error: function (error) {
                    logMessage('End Loader :: ' + error.val, 'alert');
                }
            });



            return fResult;
        }


        // ----------- Cartesian :: Empty Drawer
        async function loadPLCGetEmptyTraySlot() {

            var fResult = false;
            var chkSlot = '-';
            if (changeTakeSlot == true) {
                chkSlot = $("#txtRetrieveSlot").val();
                attemptsRetrieve += 1;
            }

            // step 2 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/GetEmptyTraySlot/" + chkSlot,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('3::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage2('Get Empty Drawer Slot :: Done ', 'info');
                        $("#txtRetrieveSlot").val(result.data.slotCode);
                        if (result.data.isLeft == true) {
                            sharedDrawerState.cartesianLocation = 'left';
                            $("#left-input").val(result.data.slotCode);
                        }
                        else {
                            sharedDrawerState.cartesianLocation = 'right';
                            $("#right-input").val(result.data.slotCode);
                        }
                    }
                    else {
                        logMessage2('Get Empty Drawer Slot :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage2('Get Empty Drawer Slot :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCTakeEmptyTray() {

            var eSlot = $("#txtRetrieveSlot").val();
            var fResult = false;

            await $.ajax({
                url: "/api/PLCHubIn/RetrieveTray/" + eSlot,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('3::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success) {
                        logMessage2('Retrieve :: Done ', 'info');
                    }
                    else {
                        logMessage2('Retrieve :: ' + result.errMessage, 'alert');
                    }

                    fResult = result.success;
                },
                error: function (error) {
                    logMessage2('Retrieve :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCGetRetrieveTrayStatus() {

            var fResult = -1;

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/GetRetrieveTrayStatus/",
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('3::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = 0;
                        logMessage2('Retrieve Status :: OK ', 'info');
                    }
                    else {
                        if (result.errMessage == "1") {
                            fResult = 1;
                            logMessage2('Retrieve Status :: No Drawer to take. ', 'info');
                        }
                        else {
                            logMessage2('Retrieve Status :: ' + result.errMessage, 'alert');
                        }
                    }
                },
                error: function (error) {
                    logMessage2('Retrieve Status :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        // ----------- Cartesian :: Put Away
        async function loadPLCGetSlot() {

            var actH = $("#txtActHeightC").val();
            var fResult = false;

            var chkSlot = '-';
            if (changePutSlot == true) {
                chkSlot = $("#txtPutSlot").val();
                attemptsPutAway += 1;
            }

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/GetBottomSlot/" + actH + "/" + chkSlot,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('4::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage2('Get Put Away Slot :: Done ', 'info');
                        $("#txtPutSlot").val(result.data.slotCode);
                        $("#txtPutSlotTake").val(result.data.totalSlot);
                        if (result.data.isLeft == true) {
                            sharedDrawerState.cartesianLocation = 'left';
                            $("#left-input").val(result.data.slotCode);
                        }
                        else {
                            sharedDrawerState.cartesianLocation = 'right';
                            $("#right-input").val(result.data.slotCode);
                        }
                    }
                    else {
                        logMessage2('Get Put Away Slot :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage2('Get Put Away Slot :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCPutAway() {

            var sCode = $("#txtPutSlot").val();
            var sTake = $("#txtPutSlotTake").val();
            var fResult = false;

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/PutAway/" + sCode + "/" + sTake,
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('4::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage2('Put Away :: Done ', 'info');
                    }
                    else {
                        logMessage2('Put Away :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage2('Put Away :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        async function loadPLCGetPutAwayStatus() {

            var fResult = false;

            // step 4 : scan item
            await $.ajax({
                url: "/api/PLCHubIn/GetPutAwayStatus/",
                type: "GET",
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                dataType: 'JSON',
                // data: JSON.stringify(jsonInput),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {

                },
                success: function (result) {
                    // console.log('4::' + JSON.stringify(result));
                    // swal.close();
                    if (result.success == true) {
                        fResult = true;
                        logMessage2('Put Away Status :: Done ', 'info');
                    }
                    else {
                        logMessage2('Put Away Status :: ' + result.errMessage, 'alert');
                    }
                },
                error: function (error) {
                    logMessage2('Put Away Status :: ' + error.val, 'alert');
                }
            });

            return fResult;
        }

        function closeTab() {
            window.close();
        }

        function exportLogFile() {
            const wb = XLSX.utils.book_new();
            wb.Props = {
                Title: "Log File",
                Subject: "Rack Job Hub In Task",
                Author: "Flex Software Consulting Sdn Bhd",
                CreatedDate: new Date()
            }

            const ws = XLSX.utils.aoa_to_sheet([]); //worksheet data

            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "HubIn Log.xlsx");
        }


    </script>

}
