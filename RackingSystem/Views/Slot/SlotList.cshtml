

<style>
    .text-link {
        color: blue;
        cursor: pointer;
        display: block;
        text-align: right;
        margin-bottom: 10px;
    }

    .hidden {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background-color: #f9f9f9; 
        border: 1px solid #ccc;
    }

    #columnMatchingLabel {
        text-align: center;
        width: 100%;
        font-weight: bold;
    }
    
    .matching-btn {
        justify-content: center;
    }

    .bi-upload {
        padding-left: 10px;
    }

    .edit-btn, .delete-btn {
        height: 33px;
        padding: 5px 10px;
        font-size: 15px;
    }

/*     .dt-input {
        margin-right: 10px;
    }

    #dt-length-0, #dt-search-0 {
        border-radius: 10px;
        padding: 8px;
    }

    th {
        background-color: #F2F2F2;
    }

    th, td {
		padding: 5px;
        /* border: 0.5px solid #EEEEEE;
    }

    .dataTable {
        border-collapse: separate !important;
        border-spacing: 0 !important;
    }

    th:first-child {
        border-top-left-radius: 10px;
    }

    th:last-child {
        border-top-right-radius: 10px;
    }

    tr:last-child td:first-child {
        border-bottom-left-radius: 10px;
    }

    tr:last-child td:last-child {
        border-bottom-right-radius: 10px;
    }

    .table-container {
        overflow-x: auto;
        width: 100%;
    }

    .table-container::-webkit-scrollbar {
        height: 6px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.3);
        border-radius: 3px;
    }

    .dt-paging {
        border: 0.5px solid #C9CDCF;
        border-radius: 15px;
    }

    /* .dt-info, .dt-paging, label {
        font-size: 15px;
    } 

    .dt-paging-button {
        border-left: 0.5px solid #C9CDCF !important;
        margin: 0px !important;
    }

    .dt-paging-button:first-child {
        border: none !important;
    }

    div.table-container .dt-container .dt-paging .dt-paging-button.current {
        color: blue !important;
        border: 0px;
        background-color: white !important;
    }

    div.table-container .dt-container .dt-paging .dt-paging-button.current:hover {
        background-color: none; 
    } */


</style>

@section PageHeader {
    <header class="d-flex align-items-center justify-content-between w-100">
        <h2 class="pageTitle">Slot Module List</h2>
        <div class="d-flex gap-2">
            <div class="btn-group">
                <button type="button" class="btn btn-warning">Import</button>
                <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="true">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu" data-popper-placement="bottom-start" style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate3d(114.5px, 40px, 0px);">
                    <li><a class="dropdown-item" href="#" id="dTemp" onclick="downloadTemp('slots')">Download Slot List Template</a></li>
                    <li><a class="dropdown-item" href="#" id="dTemp" onclick="downloadTemp('pulses')">Download Update Pulses Template</a></li>
                    <li><a class="dropdown-item" href="#" onclick="triggerFileInput('importSlot')">Import Slot from Excel</a></li>
                </ul>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none;" onchange="handleFileUpload(event)">
            </div>
            <button type="button" class="btn btn-primary" onclick="triggerFileInput('updatePulses')">
                Update Pulses By Excel
            </button>
            @* <button type="button" class="btn btn-success" onclick="newSlotColForm()">
                Add New Slot Column
            </button>
            <button type="button" class="btn btn-success" onclick="newSlotForm()">
                Add New Slot
            </button> *@
            <div class="btn-group">
                <button type="button" class="btn btn-success">Add</button>
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="newSlotForm()">Add Single Slot</a></li>
                    <li><a class="dropdown-item" href="#" onclick="newSlotColForm()">Add Range of Slots</a></li>
                </ul>
            </div>
        </div>
    </header>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card card-outline ">
                @* <div class="card-header table-title">
                    <div class="card-title">
                        <h2>Slot Module List <b></b></h2>
                    </div>
                    <div class="card-tools">
                        <div class="btn-group">
                            <button type="button" class="btn btn-warning">Import</button>
                            <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="true">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu" data-popper-placement="bottom-start" style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate3d(114.5px, 40px, 0px);">
                                <li><a class="dropdown-item" href="#" id="dTemp" onclick="downloadTemp('slots')">Download Slot List Template</a></li>
                                <li><a class="dropdown-item" href="#" id="dTemp" onclick="downloadTemp('pulses')">Download Update Pulses Template</a></li>
                                <li><a class="dropdown-item" href="#" onclick="triggerFileInput('importSlot')">Import Slot from Excel</a></li>
                            </ul>
                            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none;" onchange="handleFileUpload(event)">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="triggerFileInput('updatePulses')">
                            Update Pulses By Excel
                        </button>
                        <button type="button" class="btn btn-success" onclick="newSlotColForm()">
                            Add New Slot Column
                        </button>
                        <button type="button" class="btn btn-success" onclick="newSlotForm()">
                            Add New Slot
                        </button>
                    </div>
                </div> *@
                <div class="card-body pt-0">
                    @* <div id="gridTable" class="table table-responsive text-nowrap mt-3"></div> *@
                    <div class="text-nowrap table-container mt-1">
                        <table id="listTable" class="dataTable row-border hover order-column" style="width:100%">
                            <thead>
                                @* //dt-column-search table-bordered table-responsive dataTable hover *@
                                <tr>
                                    <th>Slot Code</th>
                                    <th>Column No</th>
                                    <th>Row No</th>
                                    <th>Active State</th>
                                    <th>Is Left</th>
                             @*        <th>Has Empty Tray</th>
                                    <th>Has Reel</th>  *@
                                    <th>X Pulse</th>
                                    <th>Y Pulse</th>
                                    <th>QR-X Pulse</th>
                                    <th>QR-Y Pulse</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="columnMatchingModal">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="columnMatchingLabel">Map CSV Columns to Data Table Columns</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="csvColumns">
          <div class="row">
              <div id="csvColumnContent"></div> 
              <div id="dataTableColumns"></div> 
          </div>
      </div>
      <div class="modal-footer matching-btn">
        <button type="button" class="btn btn-primary" onclick="processAndSubmitData()">Submit<i class="bi bi-upload fs-5"></i></button>
      </div>
      <input type="hidden" id="updateType" />
    </div>
  </div>
</div>

<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Update Slot</h4>
            </div>
            @* <form action="/Slot/SaveSlot" method="post"> *@
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtCode">Slot Code</label>
                            <input type="text" class="form-control" name="SlotCode" id="txtCode" aria-describedby="Slot Code">
                            <div id="txtCodeError" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtPriority">Priority Level <span style="">(for Reel In)</span></label>
                            <input type="number" class="form-control" name="Priority" id="txtPriority" aria-describedby="Priority Level" min="0">
                            <div id="txtPriorityError" class="error-message"></div>
                        </div>
                        @* <span asp-validation-for="SlotCode" class="text-danger"></span> *@
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtColNo">Column No</label>
                            <input type="text" class="form-control" name="ColNo" id="txtColNo" aria-describedby="Column No" min="1">
                            <div id="txtColNoError" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtRowNo">Row No</label>
                            <input type="text" class="form-control" name="RowNo" id="txtRowNo" aria-describedby="Row No" min="1">
                            <div id="txtRowNoError" class="error-message"></div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtXPulse">X Pulse</label>
                            <input type="number" class="form-control" name="XPulse" id="txtXPulse" aria-describedby="X Pulse" min="0">
                            <div id="txtXPulseError" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtYPulse">Y Pulse</label>
                            <input type="number" class="form-control" name="YPulse" id="txtYPulse" aria-describedby="Y Pulse" min="0">
                            <div id="txtYPulseError" class="error-message"></div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtQrXPulse">QR-X Pulse</label>
                            <input type="number" class="form-control" name="QrXPulse" id="txtQrXPulse" aria-describedby="Qr-X Pulse" min="0">
                            <div id="txtQrXPulseError" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtQrYPulse">QR-Y Pulse</label>
                            <input type="number" class="form-control" name="QrYPulse" id="txtQrYPulse" aria-describedby="Qr-Y Pulse" min="0">
                            <div id="txtQrYPulseError" class="error-message"></div>
                        </div>
                    </div>

                    <div id="additional" class="hidden">
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label" for="txtAddPulse1">Additional Pulse 1</label>
                                <input type="number" class="form-control" name="AddPulse1" id="txtAddPulse1" aria-describedby="Additional Pulse 1" min="0">
                                <div id="txtAddPulse1Error" class="error-message"></div>
                            </div>
                            <div class="col">
                                <label class="form-label" for="txtAddPulse2">Additional Pulse 2</label>
                                <input type="number" class="form-control" name="AddPulse2" id="txtAddPulse2" aria-describedby="Additional Pulse 2" min="0">
                                <div id="txtAddPulse2Error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label" for="txtAddPulse3">Additional Pulse 3</label>
                                <input type="number" class="form-control" name="AddPulse3" id="txtAddPulse3" aria-describedby="Additional Pulse 3" min="0">
                                <div id="txtAddPulse3Error" class="error-message"></div>
                            </div>
                            <div class="col">
                                <label class="form-label" for="txtAddPulse4">Additional Pulse 4</label>
                                <input type="number" class="form-control" name="AddPulse4" id="txtAddPulse4" aria-describedby="Additional Pulse 4" min="0">
                                <div id="txtAddPulse4Error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label" for="txtAddPulse5">Additional Pulse 5</label>
                                <input type="number" class="form-control" name="AddPulse5" id="txtAddPulse5" aria-describedby="Additional Pulse 5" min="0">
                                <div id="txtAddPulse5Error" class="error-message"></div>
                            </div>
                            <div class="col">
                                <label class="form-label" for="txtAddPulse6">Additional Pulse 6</label>
                                <input type="number" class="form-control" name="AddPulse6" id="txtAddPulse6" aria-describedby="Additional Pulse 6" min="0">
                                <div id="txtAddPulse6Error" class="error-message"></div>
                            </div>
                        </div>
                    </div>

                    <span id="textlink" class="text-link" tabIndex="0" onclick="customPulses('myModal', true)"><i class="fas fa-plus-circle"></i> Additional Pulses</span>

                    <div class="col form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="chkIsActive">
                        <label class="form-check-label" for="chkIsActive">Is Active</label>
                    </div>
                    <div class="col form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="chkIsLeft">
                        <label class="form-check-label" for="chkIsLeft">Is Left</label>
                    </div>
                    
                    <input type="hidden" id="txtId">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveSlot()">Save</button> 
                    <button type="button" class="btn btn-outline-secondary" onclick="cancelForm('myModal')">Cancel</button>
                </div>
            @* </form> *@
        </div>
    </div>
</div>

<div class="modal fade" id="colModal" role="dialog">
    <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add A Range of Slot </h4>
            </div>
            @* <form action="/Slot/SaveSlot" method="post"> *@
            <div class="modal-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label" for="txtCodeFormat">Slot Code Format</label>
                        <input type="text" class="form-control" name="SlotCodeFormat" id="txtCodeFormat" aria-describedby="Slot Code Format">
                        <div id="txtCodeFormatError" class="error-message"></div>
                    </div>
                    <div class="col">
                        <label class="form-label" for="txtPriority">Priority Level</label>
                        <input type="number" class="form-control" name="Priority" id="txtPriority" aria-describedby="Priority Level" value="0" disabled>
                        <div id="txtPriorityError" class="error-message"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label" for="txtColFrom">Column No From</label>
                        <input type="number" class="form-control" name="ColNo" id="txtColFrom" aria-describedby="Slot Code">
                        <div id="txtColFromError" class="error-message"></div>
                        @* <span asp-validation-for="SlotCode" class="text-danger"></span> *@
                    </div>
                    <div class="col">
                        <label class="form-label" for="txtTotalCol">Total Column</label>
                        <input type="number" class="form-control" name="TotalCol" id="txtTotalCol" aria-describedby="Total Col" min="1">
                        <div id="txtTotalColError" class="error-message"></div>
                    </div>
                    <div class="col">
                        <label class="form-label" for="txtRowFrom">Row No From</label>
                        <input type="number" class="form-control" name="RowNo" id="txtRowFrom" aria-describedby="Row No" min="1">
                        <div id="txtRowFromError" class="error-message"></div>

                    </div>
                    <div class="col">
                        <label class="form-label" for="txtTotalRow">Total Row</label>
                        <input type="number" class="form-control" name="TotalRow" id="txtTotalRow" aria-describedby="Total Row" min="1">
                        <div id="txtTotalRowError" class="error-message"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label" for="txtStartXPulse">X Pulse</label>
                        <input type="number" class="form-control" name="XPulse" id="txtStartXPulse" aria-describedby="X Pulse" min="0">
                        <div id="txtStartXPulseError" class="error-message"></div>

                    </div>
                    <div class="col">
                        <label class="form-label" for="txtXPulseIncrement">X Pulse Increment</label>
                        <input type="number" class="form-control" name="XPulseIncrement" id="txtXPulseIncrement" aria-describedby="X Pulse Increment" min="0">
                        <div id="txtXPulseIncrementError" class="error-message"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label" for="txtStartYPulse">Y Pulse</label>
                        <input type="number" class="form-control" name="YPulse" id="txtStartYPulse" aria-describedby="Y Pulse" min="0">
                        <div id="txtStartYPulseError" class="error-message"></div>
                    </div>
                    <div class="col">
                        <label class="form-label" for="txtYPulseIncrement">Y Pulse Increment</label>
                        <input type="number" class="form-control" name="YPulseIncrement" id="txtYPulseIncrement" aria-describedby="Y Pulse Increment" min="0">
                        <div id="txtYPulseIncrementError" class="error-message"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label" for="txtStartQrXPulse">QR-X Pulse</label>
                        <input type="number" class="form-control" name="QrXPulse" id="txtStartQrXPulse" aria-describedby="Qr-X Pulse" min="0">
                        <div id="txtStartQrXPulseError" class="error-message"></div>
                    </div>
                    <div class="col">
                        <label class="form-label" for="txtQrXPulseIncrement">QR-X Pulse Increment</label>
                        <input type="number" class="form-control" name="QrXPulseIncrement" id="txtQrXPulseIncrement" aria-describedby="Qr-X Pulse Increment" min="0">
                        <div id="txtQrXPulseIncrementError" class="error-message"></div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label" for="txtStartQrYPulse">QR-Y Pulse</label>
                        <input type="number" class="form-control" name="QrYPulse" id="txtStartQrYPulse" aria-describedby="Qr-Y Pulse" min="0">
                        <div id="txtStartQrYPulseError" class="error-message"></div>
                    </div>
                    <div class="col">
                        <label class="form-label" for="txtQrYPulseIncrement">QR-Y Pulse Increment</label>
                        <input type="number" class="form-control" name="QrYPulseIncrement" id="txtQrYPulseIncrement" aria-describedby="Qr-Y Pulse Increment" min="0">
                        <div id="txtQrYPulseIncrementError" class="error-message"></div>
                    </div>
                </div>

                <div id="additional2" class="hidden">
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtStartAddPulse1">Additional Pulse 1</label>
                            <input type="number" class="form-control" name="AddPulse1" id="txtStartAddPulse1" aria-describedby="Additional Pulse 1" min="0">
                            <div id="txtStartAddPulse1Error" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtAddPulse1Inc">Additional Pulse 1 Increment</label>
                            <input type="number" class="form-control" name="AddPulse1Inc" id="txtAddPulse1Inc" aria-describedby="Additional Pulse 1 Increment" min="0">
                            <div id="txtAddPulse1IncError" class="error-message"></div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtStartAddPulse2">Additional Pulse 2</label>
                            <input type="number" class="form-control" name="AddPulse2" id="txtStartAddPulse2" aria-describedby="Additional Pulse 2" min="0">
                            <div id="txtStartAddPulse2Error" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtAddPulse2Inc">Additional Pulse 2 Increment</label>
                            <input type="number" class="form-control" name="AddPulse2Inc" id="txtAddPulse2Inc" aria-describedby="Additional Pulse 2 Increment" min="0">
                            <div id="txtAddPulse2IncError" class="error-message"></div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtStartAddPulse3">Additional Pulse 3</label>
                            <input type="number" class="form-control" name="AddPulse3" id="txtStartAddPulse3" aria-describedby="Additional Pulse 3" min="0">
                            <div id="txtStartAddPulse3Error" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtAddPulse3Inc">Additional Pulse 3 Increment</label>
                            <input type="number" class="form-control" name="AddPulse3Inc" id="txtAddPulse3Inc" aria-describedby="Additional Pulse 3 Increment" min="0">
                            <div id="txtAddPulse3IncError" class="error-message"></div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtStartAddPulse4">Additional Pulse 4</label>
                            <input type="number" class="form-control" name="AddPulse4" id="txtStartAddPulse4" aria-describedby="Additional Pulse 4" min="0">
                            <div id="txtStartAddPulse4Error" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtAddPulse4Inc">Additional Pulse 4 Increment</label>
                            <input type="number" class="form-control" name="AddPulse4Inc" id="txtAddPulse4Inc" aria-describedby="Additional Pulse 4 Increment" min="0">
                            <div id="txtAddPulse4IncError" class="error-message"></div>
                        </div>
                   </div>
                   <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtStartAddPulse5">Additional Pulse 5</label>
                            <input type="number" class="form-control" name="AddPulse5" id="txtStartAddPulse5" aria-describedby="Additional Pulse 5" min="0">
                            <div id="txtStartAddPulse5Error" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtAddPulse5Inc">Additional Pulse 5 Increment</label>
                            <input type="number" class="form-control" name="AddPulse5Inc" id="txtAddPulse5Inc" aria-describedby="Additional Pulse 5 Increment" min="0">
                            <div id="txtAddPulse5IncError" class="error-message"></div>
                        </div>
                   </div>
                   <div class="row mb-3">
                        <div class="col">
                            <label class="form-label" for="txtStartAddPulse6">Additional Pulse 6</label>
                            <input type="number" class="form-control" name="AddPulse6" id="txtStartAddPulse6" aria-describedby="Additional Pulse 6" min="0">
                            <div id="txtStartAddPulse6Error" class="error-message"></div>
                        </div>
                        <div class="col">
                            <label class="form-label" for="txtAddPulse6Inc">Additional Pulse 6 Increment</label>
                            <input type="number" class="form-control" name="AddPulse6Inc" id="txtAddPulse6Inc" aria-describedby="Additional Pulse 6 Increment" min="0">
                           <div id="txtAddPulse6IncError" class="error-message"></div>
                        </div>
                   </div>
                </div>

                <span id="textlink2" class="text-link" tabindex="0" onclick="customPulses('colModal', true)"><i class="fas fa-plus-circle"></i> Additional Pulses</span>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="chkIsActiveRange">
                    <label class="form-check-label" for="chkIsActiveRange">Is Active</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="chkIsLeftRange">
                    <label class="form-check-label" for="chkIsLeftRange">Is Left</label>
                </div>

                <input type="hidden" id="txtId">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveRangeOfSlot()">Save</button>
                <button type="button" class="btn btn-outline-secondary" onclick="cancelForm('colModal')">Cancel</button>
            </div>
            @* </form> *@
        </div>
    </div>
</div>

@section Scripts
{
    <link rel="stylesheet" href="~/css/sweetalert2.min.css">
    <link rel="stylesheet" href="~/css/dataTables.dataTables.css">
    <link rel="stylesheet" href="~/css/columnControl.dataTables.css">

    <script src="../lib/jquery/dist/jquery.min.js"></script>
    <script src="../js/dataTables.js"></script>
    <script src="../js/dataTables.columnControl.js"></script>
    <script src="../js/columnControl.dataTables.js"></script> 

    <script src="~/js/sweetalert2.all.min.js"></script>
    <script src="../js/xlsx.full.min.js"></script>
    <script src="../js/exceljs.min.js"></script>

    @* <link rel="stylesheet" href="~/css/gridjs.min.css"> *@
    @* <script src="../js/gridjs.umd.js"></script> *@
    @* <script src="../js/jquery-3.7.1.js"></script> *@


    <script type="text/javascript">
        let uploadedFileContent = null;
        let uploadedFileExtension = null;

        $(document).ready(function () {
            loadList();
        });

        function loadList() {
            $.ajax({
                url: "/Slot/GetSlotList/",
                type: "GET",
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                    Swal.fire({
                        text: 'Please Wait',
                        width: '300px',
                        allowEscapeKey: false,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                    Swal.showLoading()
                },
                success: function (result) {
                    swal.close()
                    if (result.success == true) {
                        // dataArry = result.data;
                        
                        $('#listTable').DataTable({
                            data: result.data,
                            paging: true,
                            pageLength: 50,
                            lengthMenu: [50, 100, 250, 500, 1000],
                            columns: [
                                { data: 'slotCode' },
                                { data: 'colNo' },
                                { data: 'rowNo' },
                                {
                                    data: null,
                                    render: function (data, type, row, meta) {
                                        if (row.isActive == true) {
                                            return '<span class="badge rounded-pill bg-success" style="font-size:13px;">Active</span>'
                                        }
                                        else {
                                            return '<span class="badge rounded-pill bg-secondary" style="font-size:13px;">Inactive</span>'
                                        }
                                    }
                                },
                                {
                                    data: null,
                                    render: function (data, type, row, meta) {
                                        if (row.isLeft == true) {
                                            return '<span><i class="bi bi-check-square" style="color: darkgreen;"></i></span>'
                                        }
                                        else {
                                            return '<span><i class="bi bi-app"></i></span>'
                                        }
                                    }
                                },
                                // {
                                //     data: null,
                                //     render: function (data, type, row, meta) {
                                    //         if (row.hasEmptyTray == true) {
                                //             return '<span><i class="bi bi-check-square"></i></span>'
                                //         }
                                //         else {
                                //             return '<span><i class="bi bi-app""></i></span>'
                                //         }
                                //     }
                                // },
                                // {
                                //     data: null,
                                //     render: function (data, type, row, meta) {
                                //         if (row.hasReel == true) {
                                //             return '<span><i class="bi bi-check-square"></i></span>'
                                //         }
                                //         else {
                                //             return '<span><i class="bi bi-app""></i></span>'
                                //         }
                                //     }
                                // },
                                { data: 'xPulse' },
                                { data: 'yPulse' },
                                { data: 'qrxPulse' },
                                { data: 'qryPulse' },
                                {
                                    data: null,
                                    render: function (data, type, row, meta) {
                                        const rowData = JSON.stringify(row).replace(/"/g, "&quot;");  //replace all double quotes with HTML entity  //custom data attribute >> data-*
                                        return `<div style="display:flex;">
                                                    <button class="btn btn-warning d-grid edit-btn" style="margin-right: 10px;" data-row="${rowData}">
                                                        <span><i class="bi bi-pencil-square"></i>Edit</span>
                                                    </button>
                                                    <button class="btn btn-danger delete-btn" data-id="${row.slot_Id}" data-code="${row.slotCode}">
                                                        <span><i class="bi bi-trash"></i>Delete</span>
                                                    </button>
                                                </div>`;
                                    }
                                }
                            ],
                            language: {
                                searchPlaceholder: "🔍︎ Search",
                                search: ""
                            },
                            ordering: {
                                indicators: false
                            },
                            columnControl: ['orderStatus']
                        });
                        
                    }
                    else {
                        swal.fire({
                            icon: 'error',
                            title: "Wait",
                            text: result.errMessage
                        });
                    }
                },
                error: function (error) {
                    swal.fire({
                        icon: 'error',
                        title: "Wait",
                        text: error.val
                    });
                }
            });       
           
        }

        function newSlotForm() {
            $("#txtId").val("0");
            $("#txtCode").val("");
            $("#txtColNo").val("");
            $("#txtRowNo").val("");
            $("#txtXPulse").val("");
            $("#txtYPulse").val("");
            $("#txtQrXPulse").val("");
            $("#txtQrYPulse").val("");
            $('#txtAddPulse1').val("");
            $('#txtAddPulse2').val("");
            $('#txtAddPulse3').val("");
            $('#txtAddPulse4').val("");
            $('#txtAddPulse5').val("");
            $('#txtAddPulse6').val("");

            // const inputFields = ['#txtCode', '#txtColNo', '#']
            document.getElementById("chkIsActive").checked = true;
            document.getElementById("chkIsLeft").checked = false;
            $("#myModal").modal("show");
        }

        function newSlotColForm() {
            // $("#txtId").val("0");
            // $("#txtCode").val("");
            // $("#txtColNo").val("");
            // $("#txtRowNo").val("");
            document.getElementById("chkIsActiveRange").checked = true;
            $("#colModal").modal("show");
        }

        $('#listTable').on('click', '.edit-btn', function () {
            const row = JSON.parse($(this).attr('data-row'));
            console.log("row", row);
            editSlotForm(row);
        });

        function editSlotForm(row){
            var hasValue = false;

            $("#txtId").val(row.slot_Id);
            $("#txtCode").val(row.slotCode);
            $("#txtColNo").val(row.colNo);
            $("#txtRowNo").val(row.rowNo);
            $("#txtXPulse").val(row.xPulse);
            $("#txtYPulse").val(row.yPulse);
            $("#txtQrXPulse").val(row.qrxPulse);
            $("#txtQrYPulse").val(row.qryPulse);
            $("#txtPriority").val(row.priority);

            var addPulseFields = [
                { field: "#txtAddPulse1", value: row.add1Pulse },
                { field: "#txtAddPulse2", value: row.add2Pulse },
                { field: "#txtAddPulse3", value: row.add3Pulse },
                { field: "#txtAddPulse4", value: row.add4Pulse },
                { field: "#txtAddPulse5", value: row.add5Pulse },
                { field: "#txtAddPulse6", value: row.add6Pulse }
            ];

            addPulseFields.forEach(function(item) {
                $(item.field).val(item.value > 0 ? item.value : "");
                if (item.value > 0) hasValue = true;
            });

            document.getElementById("chkIsActive").checked = row.isActive === true || row.isActive === "true";
            document.getElementById("chkIsLeft").checked = row.isLeft === true || row.isLeft === "true";
            if (hasValue) customPulses('myModal', true);

            $("#myModal").modal("show");
        }

        function customPulses(modalId, isChange) {
            let container, text;

            if (modalId === "myModal") {
                container = document.getElementById("additional");
                text = document.getElementById("textlink");
            } else {
                container = document.getElementById("additional2");
                text = document.getElementById("textlink2");
            }

            const isHidden = container.classList.contains("hidden");

            if (isHidden) {
                if (isChange)
                {
                    container.classList.remove("hidden");
                    text.innerHTML = '<i class="fas fa-minus-circle"></i> Additional Pulses';
                }

                if (modalId == "myModal") {
                    for (let i = 1; i <= 6; i++) {
                        removeErrMsg(`txtAddPulse${i}`);
                    }
                }
                else
                {
                    for (let i = 1; i <= 6; i++) {
                        removeErrMsg(`txtStartAddPulse${i}`);
                        removeErrMsg(`txtAddPulse${i}Inc`);
                    }
                }

            } else {

                container.classList.add("hidden");
                text.innerHTML = '<i class="fas fa-plus-circle"></i> Additional Pulses';


                if (modalId == "myModal") {
                    for (let i = 1; i <= 6; i++) {
                        const field = document.getElementById(`txtAddPulse${i}`);
                        if (field) field.value = "";
                    }
                }
                else
                {
                    for (let i = 1; i <= 6; i++) {
                        const field = document.getElementById(`txtStartAddPulse${i}`);
                        const field2 = document.getElementById(`txtAddPulse${i}Inc`);
                        if (field) field.value = "";
                        if (field2) field2.value = "";
                    }
                }
            }
        }

        function cancelForm(modalId) {
            $('#' + modalId).modal("toggle");
            var fields;

            if (modalId == "colModal") {
                fields = ['txtCodeFormat', 'txtColFrom', 'txtTotalCol', 'txtRowFrom', 'txtTotalRow', 'txtStartXPulse', 'txtXPulseIncrement', 'txtStartYPulse', 'txtYPulseIncrement', 'txtStartQrXPulse', 'txtQrXPulseIncrement', 'txtStartQrYPulse', 'txtQrYPulseIncrement'];
            }
            else {
                fields = ['txtCode', 'txtPriority', 'txtColNo', 'txtRowNo', 'txtXPulse', 'txtYPulse', 'txtQrXPulse', 'txtQrYPulse', 'txtAddPulse1', 'txtAddPulse2', 'txtAddPulse3', 'txtAddPulse4', 'txtAddPulse5', 'txtAddPulse6'];
            }
            removeErrMsg(fields, true);
            customPulses(modalId);
        }

        function saveSlot() {
            // let addPulseFields;
            // addPulseFields = [
            //     { id: 'txtAddPulse1', name: 'Additional Pulse 1', required: true, numeric: true, min: 0 },
            //     { id: 'txtAddPulse2', name: 'Additional Pulse 2', required: true, numeric: true, min: 0 },
            //     { id: 'txtAddPulse3', name: 'Additional Pulse 3', required: true, numeric: true, min: 0 },
            //     { id: 'txtAddPulse4', name: 'Additional Pulse 4', required: true, numeric: true, min: 0 },
            //     { id: 'txtAddPulse5', name: 'Additional Pulse 5', required: true, numeric: true, min: 0 },
            //     { id: 'txtAddPulse6', name: 'Additional Pulse 6', required: true, numeric: true, min: 0 },
            // ];

            // const isHidden = document.querySelector('#additional').classList.contains('hidden');
            const fields = [
                { id: 'txtCode', name: 'Slot Code', required: true, numeric: false },
                { id: 'txtColNo', name: 'Column No', required: true, numeric: true, min: 1 },
                { id: 'txtRowNo', name: 'Row No', required: true, numeric: true, min: 1 },
                { id: 'txtXPulse', name: 'X Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtYPulse', name: 'Y Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtQrXPulse', name: 'Qr-X Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtQrYPulse', name: 'Qr-Y Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtPriority', name: 'Priority', required: true, numeric: true, min: 0 },
                // ...(!isHidden ? addPulseFields : [])
            ];

            if (validateColModal(fields)) {
                var data = {
                    Slot_Id: Number($("#txtId").val()) || 0,
                    SlotCode: $("#txtCode").val(),
                    ColNo: parseInt($("#txtColNo").val()) || 0,
                    RowNo: parseInt($("#txtRowNo").val()) || 0,
                    XPulse: parseInt($("#txtXPulse").val()) || 0,
                    YPulse: parseInt($("#txtYPulse").val()) || 0,
                    QRXPulse: parseInt($("#txtQrXPulse").val()) || 0,
                    QRYPulse: parseInt($("#txtQrYPulse").val()) || 0,
                    Add1Pulse: parseInt($('#txtAddPulse1').val()) || 0,
                    Add2Pulse: parseInt($('#txtAddPulse2').val()) || 0,
                    Add3Pulse: parseInt($('#txtAddPulse3').val()) || 0,
                    Add4Pulse: parseInt($('#txtAddPulse4').val()) || 0,
                    Add5Pulse: parseInt($('#txtAddPulse5').val()) || 0,
                    Add6Pulse: parseInt($('#txtAddPulse6').val()) || 0,
                    IsActive: $('#myModal').find('#chkIsActive').prop("checked"),
                    IsLeft: $('#myModal').find('#chkIsLeft').prop("checked"),
                    Priority: parseInt($('#txtPriority').val()),
                };

                $.ajax({
                    url: '/Slot/SaveSlot',
                    type: 'POST',
                    data: JSON.stringify(data),
                    dataType: 'JSON',
                    contentType: 'application/json; charset=utf-8',
                    beforeSend: function () {
                        Swal.fire({
                            text: 'Please Wait',
                            width: '300px',

                            allowEscapeKey: false,
                            allowOutsideClick: false,
                            showConfirmButton: false,
                        });
                        Swal.showLoading()
                    },
                    success: function (result) {
                        if (result.success == true) {
                            $("#myModal").modal("toggle");
                            swal.fire({
                                icon: 'success',
                                title: "Success Update",
                                text: "",
                                didClose: () => {
                                    window.location.reload();
                                }
                            });
                        }
                        else {
                            swal.fire({
                                icon: 'error',
                                title: "Wait",
                                text: result.errMessage
                            });
                        }
                    },
                    error: function (error) {
                        console.log(error);
                        swal.fire({
                            icon: 'error',
                            title: "Wait",
                            text: error.val
                        });
                    }
                });
            }
        }

        $('#listTable').on('click', '.delete-btn', function () {
            const id = $(this).attr('data-id');
            const slotCode = $(this).attr('data-code');
            deleteSlot(id, slotCode);
        });

        function deleteSlot(id, slotCode) {
            swal.fire({
                title: "Are you sure want to delete?",
                text: "You will not be able to recover this record!",
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'ok',
                cancelButtonText: 'cancel',
                allowOutsideClick: false
                }).then(function(r) {
                if (r.isConfirmed == true) {
                    var data = {
                        Slot_Id: id,
                        SlotCode: slotCode,
                        ColNo: 0,
                        RowNo: 0,
                        IsActive: false
                    }

                    $.ajax({
                        url: '/Slot/DeleteSlot',
                        type: 'DELETE',
                        data: JSON.stringify(data),
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        beforeSend: function () {
                            Swal.fire({
                                text: 'Please Wait',
                                width: '300px',

                                allowEscapeKey: false,
                                allowOutsideClick: false,
                                showConfirmButton: false,
                            });
                            Swal.showLoading()
                        },
                        success: function (result) {
                            if (result.success == true) {
                                swal.fire({
                                    icon: 'success',
                                    title: "Success Deleted",
                                    text: "",
                                    didClose: () => {
                                        window.location.reload();
                                    }
                                });
                            }
                            else {
                                swal.fire({
                                    icon: 'error',
                                    title: "Wait",
                                    text: result.errMessage
                                });
                            }
                        },
                        error: function (error) {
                            console.log(error);
                            swal.fire({
                                icon: 'error',
                                title: "Wait",
                                text: error.val
                            });
                        }
                    });

                } else {
                    return;
                }
                });

        }

        function validateColModal(fields) {
            // Remove all previous errors
            removeErrMsg(fields.map(f => f.id));

            let isValid = true;
            fields.forEach(field => {
                const value = document.getElementById(field.id).value.trim();
                if (field.required && value === '') {
                    showError(field.id, `Please enter a ${field.name}.`);
                    isValid = false;
                    return;
                }

                if (field.numeric && (isNaN(value.trim()) || Number(value) < (field.min))) {
                    showError(field.id, `Please enter a valid ${field.name} (number >= ${field.min}).`);
                    isValid = false;
                }
            });

            return isValid;
        }

        // Show error message and highlight invalid fields
        function showError(fieldId, message) {
            document.getElementById(fieldId).classList.add('is-invalid');
            document.getElementById(fieldId + 'Error').textContent = message;
        }

        function removeErrMsg(fields, clearValue = false) {
            if (!Array.isArray(fields)) {
                fields = [fields];
            }

            fields.forEach(function(field) {
                document.getElementById(field).classList.remove('is-invalid');
                document.getElementById(field).classList.remove('is-valid');
                document.getElementById(field + 'Error').textContent = '';
                if (clearValue) document.getElementById(field).value = '';
            });
        }

        function saveRangeOfSlot() {
            const fields = [
                { id: 'txtCodeFormat', name: 'Slot Code Format', required: true, numeric: false },
                { id: 'txtColFrom', name: 'Column No From', required: true, numeric: true, min: 1 },
                { id: 'txtTotalCol', name: 'Total Column', required: true, numeric: true, min: 1 },
                { id: 'txtRowFrom', name: 'Row No From', required: true, numeric: true, min: 1 },
                { id: 'txtTotalRow', name: 'Total Row', required: true, numeric: true, min: 1 },
                { id: 'txtStartXPulse', name: 'X Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtXPulseIncrement', name: 'X Pulse Increment', required: true, numeric: true, min: 0 },
                { id: 'txtStartYPulse', name: 'Y Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtYPulseIncrement', name: 'Y Pulse Increment', required: true, numeric: true, min: 0 },
                { id: 'txtStartQrXPulse', name: 'Qr-X Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtQrXPulseIncrement', name: 'Qr-X Pulse Increment', required: true, numeric: true, min: 0 },
                { id: 'txtStartQrYPulse', name: 'Qr-Y Pulse', required: true, numeric: true, min: 0 },
                { id: 'txtQrYPulseIncrement', name: 'Qr-Y Pulse Increment', required: true, numeric: true, min: 0 },
            ];

            if (validateColModal(fields)) {
                var data = {
                    SlotFormat: $('#txtCodeFormat').val(),
                    StartCol: parseInt($("#txtColFrom").val()) || 0,
                    TotalCols: parseInt($("#txtTotalCol").val()) || 0,
                    StartRow: parseInt($("#txtRowFrom").val()) || 0,
                    TotalRows: parseInt($("#txtTotalRow").val()) || 0,
                    XPulse: parseInt($("#txtStartXPulse").val()) || 0,
                    XPulseIncrement: parseInt($("#txtXPulseIncrement").val()) || 0,
                    YPulse: parseInt($("#txtStartYPulse").val()) || 0,
                    YPulseIncrement: parseInt($("#txtYPulseIncrement").val()) || 0,
                    QRXPulse: parseInt($("#txtStartQrXPulse").val()) || 0,
                    QRXPulseIncrement: parseInt($("#txtQrXPulseIncrement").val()) || 0,
                    QRYPulse: parseInt($("#txtStartQrYPulse").val()) || 0,
                    QRYPulseIncrement: parseInt($("#txtQrYPulseIncrement").val()) || 0,
                    Add1Pulse: parseInt($('#txtStartAddPulse1').val()) || 0,
                    Add1PulseIncrement: parseInt($('#txtAddPulse1Inc').val()) || 0,
                    Add2Pulse: parseInt($('#txtStartAddPulse2').val()) || 0,
                    Add2PulseIncrement: parseInt($("#txtAddPulse2Inc").val()) || 0,
                    Add3Pulse: parseInt($('#txtStartAddPulse3').val()) || 0,
                    Add3PulseIncrement: parseInt($('#txtAddPulse3Inc').val()) || 0,
                    Add4Pulse: parseInt($('#txtStartAddPulse4').val()) || 0,
                    Add4PulseIncrement: parseInt($('#txtAddPulse4Inc').val()) || 0,
                    Add5Pulse: parseInt($('#txtStartAddPulse5').val()) || 0,
                    Add5PulseIncrement: parseInt($('#txtAddPulse5Inc').val()) || 0,
                    Add6Pulse: parseInt($('#txtStartAddPulse6').val()) || 0,
                    Add6PulseIncrement: parseInt($('#txtAddPulse6Inc').val()) || 0,
                    IsActive: $('#colModal').find('#chkIsActiveRange').prop("checked"),
                    IsLeft: $('#colModal').find('#chkIsLeftRange').prop("checked"),
                };

            $.ajax({
                url: '/Slot/SaveRangeOfSlot',
                type: 'POST',
                data: JSON.stringify(data),
                dataType: 'JSON',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function () {
                    Swal.fire({
                        text: 'Please Wait',
                        width: '300px',
                        allowEscapeKey: false,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                    Swal.showLoading()
                },
                success: function (result) {
                    if (result.success == true) {
                        $("#colModal").modal("toggle");
                        swal.fire({
                            icon: 'success',
                            title: "Success Update",
                            text: "",
                            didClose: () => {
                                window.location.reload();
                            }
                        });
                    }
                    else {
                        swal.fire({
                            icon: 'error',
                            title: "Wait",
                            text: result.errMessage
                        });
                    }
                },
                error: function (error) {
                    console.log(error);
                    swal.fire({
                        icon: 'error',
                        title: "Wait",
                        text: error.val
                    });
                }
            });
            }

        }

        //download template method
        function downloadTemp(type) {
            var book = XLSX.utils.book_new();
            book.Props = {
                Title: "Template",
                Subject: type === "slots" ? "Slot List" : "Pulses",
                Author: "Flex Software Consulting Sdn Bhd",
                CreatedDate: new Date()
            };

            var book_header = type === "slots" ? [
                ['Slot Code', 'Column No', 'Row No', 'Is Active', 'Is Left', 'X Pulse', 'Y Pulse', 'QR-X Pulse', 'QR-Y Pulse',
                'Additional Pulse 1', 'Additional Pulse 2', 'Additional Pulse 3', 'Additional Pulse 4', 'Additional Pulse 5', 'Additional Pulse 6', 'Priority']
            ]
            : [
                ['Slot Code', 'X Pulse', 'Y Pulse', 'QR-X Pulse', 'QR-Y Pulse',
                'Additional Pulse 1', 'Additional Pulse 2', 'Additional Pulse 3', 'Additional Pulse 4', 'Additional Pulse 5', 'Additional Pulse 6']
            ];

            // var booksheet = XLSX.utils.aoa_to_sheet(book_header);
            var booksheet = XLSX.utils.aoa_to_sheet(book_header);
            booksheet['!cols'] = type === "slots" ? [
                {wpx: 90}, {wpx: 60}, {wpx: 50}, {wpx: 50}, {wpx: 50}, {wpx: 50}, {wpx: 50},
                {wpx: 60}, {wpx: 60}, {wpx: 100}, {wpx: 100}, {wpx: 100}, {wpx: 100}, {wpx: 100}, {wpx: 100}, {wpx: 100}
            ] : [
                {wpx: 90}, {wpx: 50}, {wpx: 50}, {wpx: 60}, {wpx: 60},
                {wpx: 100}, {wpx: 100}, {wpx: 100}, {wpx: 100}, {wpx: 100}, {wpx: 100}
            ]
            XLSX.utils.book_append_sheet(book, booksheet, "Sheet1");
            XLSX.writeFile(book, type === "slots" ? "SlotListTemplate.xlsx" : "PulsesTemplate.xlsx");
        }

        //import excel method
        function triggerFileInput(source) {
            const input = document.getElementById('fileInput');
            input.value = "";  //reset input so select on same file can trigger change
            input.dataset.source = source;
            input.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const source = event.target.dataset.source;

            if (file)
            {
                const reader = new FileReader();
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension === 'csv' || fileExtension === 'xlsx' || fileExtension === 'xls') {
                    reader.onload = function(e) {
                        const content = e.target.result;
                        processFileContent(content, fileExtension, source);
                    };

                    if (fileExtension === 'csv') {
                        reader.readAsText(file);
                    } else {
                        reader.readAsArrayBuffer(file);
                    }
                }
                else {
                    alert("Only CSV, XLSX, and XLS files are supported.");
                }
            }
        }

        function processFileContent(content, fileExtension, source) {
            try {
                let data;

                if (fileExtension === 'csv') {
                    data = XLSX.read(content, { type: 'string', codepage: 65001 });
                    data = XLSX.utils.sheet_to_json(data.Sheets[data.SheetNames[0]], { header: 1 });
                } else {
                    const workbook = XLSX.read(content, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                }

                if (!data || data.length === 0) {
                    alert("The uploaded file appears to be empty or malformed.");
                    return;
                }

                const columns = data[0];
                if (columns.length === 0) {
                    alert("No headers found in the file.");
                    return;
                }

                uploadedFileContent = content;
                uploadedFileExtension = fileExtension;

                console.log(uploadedFileContent);
                console.log(uploadedFileExtension);

                showColumnMapping(columns, source);
            } catch (error) {
                console.error("Error processing the file:", error);
                alert("Failed to process the uploaded file.");
            }
        }

        function showColumnMapping(columns, source) {
            let dataTableColumns;

            if (source == "importSlot") {
                dataTableColumns = ['Slot Code', 'Column No', 'Row No', 'Is Active', 'Is Left', 'X Pulse', 'Y Pulse', 'QR-X Pulse', 'QR-Y Pulse',
                                        'Additional Pulse 1', 'Additional Pulse 2', 'Additional Pulse 3', 'Additional Pulse 4', 'Additional Pulse 5', 'Additional Pulse 6', 'Priority'];
                $('#updateType').val("slots");
            }
            else {
                dataTableColumns = ['Slot Code',  'X Pulse', 'Y Pulse', 'QR-X Pulse', 'QR-Y Pulse',
                                        'Additional Pulse 1', 'Additional Pulse 2', 'Additional Pulse 3', 'Additional Pulse 4', 'Additional Pulse 5', 'Additional Pulse 6'];
                $('#updateType').val("pluses");
            }

            let columnDropdowns = '';

            const isMatch = (col1, col2) => {
                const col1Str = String(col1).toLowerCase().replace(/\s+/g, '');
                const col2Str = String(col2).toLowerCase().replace(/\s+/g, '');
                return col1Str === col2Str;
            };

            columns.forEach((column, index) => {
                const matchedCol = dataTableColumns.find(col => isMatch(col, column));

                columnDropdowns += `
                    <div class="row justify-content-center align-items-center mb-3">
                        <div class="col-5">
                            <label class="form-label mb-0">File Column: ${column}</label>
                        </div>
                        <div class="col-5">
                            <select class="form-select column-mapping"
                                    data-col="${column}"
                                    id="column${index}">
                                <option value="">Select Matching Column</option>
                                ${dataTableColumns.map(col => `
                                    <option value="${col}" ${matchedCol === col ? 'selected' : ''}>${col}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>`;
            });

            document.getElementById('csvColumns').innerHTML = columnDropdowns;
            $('#columnMatchingModal').modal("show");
        }

        function captureUserMappings() {
            const mappings = {};
            document.querySelectorAll('.column-mapping').forEach((selectElement, index) => {
                const selectedValue = selectElement.value;
                const columnName = selectElement.getAttribute('data-col');
                if (selectedValue) {
                    mappings[columnName] = selectedValue;
                } else {
                    console.log(`No selection for column: ${columnName}`);
                }
            });
            return mappings;
        }

        function processAndSubmitData() {
            let workbook;
            let slotsData;
            userMappings = captureUserMappings();
            content = uploadedFileContent;
            fileExtension = uploadedFileExtension;
            const updateType = $('#updateType').val();

            try {
                if (fileExtension === 'csv') {
                    workbook = XLSX.read(content, { type: 'string', codepage: 65001 });
                } else {
                    workbook = XLSX.read(content, { type: 'array' });
                }

                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                const columns = data[0];
                const colIndex = {};

                if (updateType === "slots")
                {
                    const fieldNames = [
                        'Slot Code', 'Column No', 'Row No', 'X Pulse', 'Y Pulse', 'QR-X Pulse', 'QR-Y Pulse',
                        'Additional Pulse 1', 'Additional Pulse 2', 'Additional Pulse 3', 'Additional Pulse 4', 'Additional Pulse 5', 'Additional Pulse 6',
                        'Is Active', 'Is Left', 'Priority'
                    ];
                    fieldNames.forEach(field => {
                        colIndex[field] = columns.indexOf(normalizeString(userMappings, field));
                    });

                    const parseBool = val =>
                        val === true || val === 1 || val === '1' || val === 'true' || val === 'TRUE';

                    slotsData = data.slice(1).map(row => {
                        return {
                            Slot_Id: 0,
                            SlotCode: row[colIndex['Slot Code']],
                            ColNo: row[colIndex['Column No']],
                            RowNo: row[colIndex['Row No']],
                            HasEmptyTray: parseBool(row[colIndex['Has Empty Tray']]),
                            HasReel: parseBool(row[colIndex['Has Reel']]),
                            XPulse: row[colIndex['X Pulse']],
                            YPulse: row[colIndex['Y Pulse']],
                            QRXPulse: row[colIndex['QR-X Pulse']],
                            QRYPulse: row[colIndex['QR-Y Pulse']],
                            Add1Pulse: row[colIndex['Additional Pulse 1']],
                            Add2Pulse: row[colIndex['Additional Pulse 2']],
                            Add3Pulse: row[colIndex['Additional Pulse 3']],
                            Add4Pulse: row[colIndex['Additional Pulse 4']],
                            Add5Pulse: row[colIndex['Additional Pulse 5']],
                            Add6Pulse: row[colIndex['Additional Pulse 6']],
                            IsActive: parseBool(row[colIndex['Is Active']]),
                            IsLeft: parseBool(row[colIndex['Is Left']]),
                            Priority: row[colIndex['Priority']],
                        };
                    });
                }
                else {
                    const fieldNames = [
                        'Slot Code','X Pulse', 'Y Pulse', 'QR-X Pulse', 'QR-Y Pulse',
                        'Additional Pulse 1', 'Additional Pulse 2', 'Additional Pulse 3', 'Additional Pulse 4', 'Additional Pulse 5', 'Additional Pulse 6',
                        'Is Active', 'Is Left'
                    ];
                    fieldNames.forEach(field => {
                        colIndex[field] = columns.indexOf(normalizeString(userMappings, field));
                    });

                    // const parseBool = val =>
                    //     val === true || val === 1 || val === '1' || val === 'true' || val === 'TRUE';

                    slotsData = data.slice(1).map(row => {
                        return {
                            // SlotId: 0,
                            SlotCode: row[colIndex['Slot Code']],
                            XPulse: row[colIndex['X Pulse']],
                            YPulse: row[colIndex['Y Pulse']],
                            QRXPulse: row[colIndex['QR-X Pulse']],
                            QRYPulse: row[colIndex['QR-Y Pulse']],
                            Add1Pulse: row[colIndex['Additional Pulse 1']],
                            Add2Pulse: row[colIndex['Additional Pulse 2']],
                            Add3Pulse: row[colIndex['Additional Pulse 3']],
                            Add4Pulse: row[colIndex['Additional Pulse 4']],
                            Add5Pulse: row[colIndex['Additional Pulse 5']],
                            Add6Pulse: row[colIndex['Additional Pulse 6']],
                            // IsActive: parseBool(row[colIndex['Is Active']]),
                            // IsLeft: parseBool(row[colIndex['Is Left']]),
                        };
                    });
                }

                saveExcelSlots(slotsData, content, updateType);

            } catch (error) {
                console.error("Error processing the file:", error);
                alert("Failed to process the uploaded file.");
            }
        }

        function normalizeString(userMappings, str) {
            var rValue = str;

            if (userMappings != null)
            {
                rValue = userMappings[str];
            }

            return rValue;
        }

        function saveExcelSlots(slotsData, bookBuffer, source) {
            const url = source == "slots" ? '/Slot/SaveExcelSlot' : '/Slot/UpdateExcelPulses';
            console.log(JSON.stringify(slotsData));

            if (slotsData != null)
            {
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(slotsData),
                    dataType: 'JSON',
                    contentType: 'application/json; charset=utf-8',
                    beforeSend: function () {
                        Swal.fire({
                            text: 'Please Wait',
                            width: '300px',

                            allowEscapeKey: false,
                            allowOutsideClick: false,
                            showConfirmButton: false,
                        });
                        Swal.showLoading()
                    },
                    success: function(response) {
                        if (response.success == true) {
                            swal.fire({
                                icon: 'success',
                                title: "Success Update",
                                text: "",
                                didClose: () => {
                                    window.location.reload();
                                }
                            });
                        } else {
                            if (response.data && response.data.length > 0) {
                                markErrorsInSheet(bookBuffer, response.data, source);
                                swal.fire({
                                    icon: 'warning',
                                    title: "Validation Issues Found",
                                    text: "Review on returned file and fix errors."
                                });
                                $('#columnMatchingModal').modal("toggle");

                            } else {
                                swal.fire({
                                    icon: 'error',
                                    title: "Wait",
                                    text: response.errMessage
                                });
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log(error);
                        swal.fire({
                            icon: 'error',
                            title: "Wait",
                            text: error.val
                        });
                    }
                });
            }
        }

        async function markErrorsInSheet(bookBuffer, errorRows, updateType) {
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(bookBuffer);
                const worksheet = workbook.getWorksheet(1);
                const columnsToHighlight = updateType === "slots" ? [1, 2, 3, 16] : [1, 12];

                // let colorIndex = 0;
                // const highlightColors = [
                //     'FFCCCC',
                //     'FFE5CC',
                //     'FFFFCC',
                //   ];

                // Add "Error" header
                const headerRow = worksheet.getRow(1);
                const errIdx = updateType === "slots" ? 16 : 12;
                headerRow.getCell(errIdx).value = 'Error';
                headerRow.commit();

                const errorMap = new Map();
                errorRows.forEach(e => errorMap.set(e.slotCode, e.errorMsg));
                console.log(errorRows);

                worksheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
                if (rowNumber === 1) return; //skip header row

                const slotCode = row.getCell(1).value;

                if (errorMap.has(slotCode)) {
                    const errorMsg = errorMap.get(slotCode);

                    // const fillColor = highlightColors[colorIndex % highlightColors.length];
                    // colorIndex++;
                    console.log("error index" , errIdx);
                    console.log(columnsToHighlight);

                    columnsToHighlight.forEach(colNum => {
                    const cell = row.getCell(colNum);
                    console.log("colNumber:", colNum);
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFCCCC' }
                    };
                    });

                    row.getCell(errIdx).value = errorMsg;
                }
                });

                // Export updated file
                const updatedBuffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([updatedBuffer], {
                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                });

                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "SlotList_Errors.xlsx";
                link.click();

                Swal.fire({
                    icon: 'warning',
                    title: "Validation Issues Found",
                    text: "Review on returned file and fix errors."
                });
        }

    </script>

}